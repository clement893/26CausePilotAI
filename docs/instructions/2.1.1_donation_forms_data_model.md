# Instructions Détaillées pour Cursor - Étape 2.1.1

**Phase:** 2 - Collecte  
**Étape:** 2.1 - Module Formulaires de Don  
**Fonctionnalité:** 2.1.1 - Modèle de Données pour les Formulaires  
**Prérequis:** Phase 1 complétée

---

## Contexte

Nous créons les modèles de données nécessaires pour gérer les formulaires de don, leurs soumissions, les intentions de paiement et les abonnements pour dons récurrents. Ces modèles sont au cœur du système de collecte de fonds.

**Référence cahier des charges:** Section 5 - Module Formulaires de Don

---

## 1. Modèle DonationForm

**Ajouter dans:** `/packages/database/prisma/schema.prisma`

Ce modèle représente un formulaire de don configurable.

```prisma
model DonationForm {
  id          String   @id @default(cuid())
  
  // Informations de base
  title       String   // Titre du formulaire
  description String?  @db.Text // Description longue
  slug        String   @unique // URL-friendly (ex: "campagne-noel-2026")
  
  // Configuration des montants
  amountType  String   @default("flexible") // flexible, fixed
  suggestedAmounts Json // Array de montants suggérés [25, 50, 100, 250, 500]
  minAmount   Decimal? @db.Decimal(10, 2) // Montant minimum
  maxAmount   Decimal? @db.Decimal(10, 2) // Montant maximum
  currency    String   @default("CAD") // CAD, USD, EUR
  
  // Dons récurrents
  allowRecurring Boolean @default(false) // Autoriser les dons récurrents
  frequencies    Json?   // Array de fréquences ["monthly", "quarterly", "yearly"]
  
  // Champs du formulaire
  requiredFields Json    // Array de champs requis ["email", "firstName", "lastName"]
  optionalFields Json    // Array de champs optionnels activés ["phone", "address", "message"]
  customFields   Json?   // Array de champs personnalisés avec config
  
  // Design et branding
  primaryColor   String  @default("#3B82F6") // Couleur principale (hex)
  logo           String? // URL du logo
  coverImage     String? // URL de l'image de couverture
  font           String  @default("Inter") // Police de caractères
  buttonStyle    String  @default("gradient") // solid, outline, gradient
  
  // Messages
  welcomeMessage   String? @db.Text // Message au-dessus du formulaire
  thankYouMessage  String? @db.Text // Message après don
  emailTemplate    String? @db.Text // Template d'email de confirmation
  redirectUrl      String? // URL de redirection après don
  
  // Paramètres avancés
  enableConsents   Boolean @default(true) // Activer les consentements RGPD
  consentText      String? @db.Text // Texte des consentements personnalisé
  enableCaptcha    Boolean @default(false) // Activer reCAPTCHA
  maxDonations     Int?    // Limite de nombre de dons (optionnel)
  startDate        DateTime? // Date de début (optionnel)
  endDate          DateTime? // Date de fin (optionnel)
  goalAmount       Decimal? @db.Decimal(10, 2) // Objectif de collecte (optionnel)
  
  // Statistiques (calculées)
  totalCollected   Decimal @default(0) @db.Decimal(10, 2)
  donationCount    Int     @default(0)
  viewCount        Int     @default(0)
  submissionCount  Int     @default(0)
  conversionRate   Decimal @default(0) @db.Decimal(5, 2) // Pourcentage
  
  // Statut
  status        String   @default("draft") // draft, published, archived
  isActive      Boolean  @default(true)
  
  // Relations
  submissions   DonationFormSubmission[]
  subscriptions Subscription[]
  
  // Organisation (multi-tenant)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Timestamps
  publishedAt   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([slug])
  @@index([organizationId])
  @@index([status])
  @@map("donation_forms")
}
```

**Champs obligatoires:** `id`, `title`, `slug`, `amountType`, `suggestedAmounts`, `currency`, `requiredFields`, `optionalFields`, `primaryColor`, `font`, `buttonStyle`, `status`, `organizationId`

---

## 2. Modèle DonationFormSubmission

Ce modèle représente une soumission d'un formulaire de don par un donateur.

```prisma
model DonationFormSubmission {
  id          String   @id @default(cuid())
  
  // Formulaire lié
  formId      String
  form        DonationForm @relation(fields: [formId], references: [id], onDelete: Cascade)
  
  // Donateur
  donatorId   String?  // Peut être null si donateur anonyme
  donator     Donator? @relation(fields: [donatorId], references: [id], onDelete: SetNull)
  
  // Montant
  amount      Decimal  @db.Decimal(10, 2)
  currency    String   @default("CAD")
  
  // Récurrence
  isRecurring Boolean  @default(false)
  frequency   String?  // monthly, quarterly, yearly (si isRecurring = true)
  
  // Données du formulaire (JSON)
  formData    Json     // Toutes les données saisies par le donateur
  
  // Informations du donateur (dénormalisées pour historique)
  email       String
  firstName   String?
  lastName    String?
  phone       String?
  address     String?
  city        String?
  province    String?
  postalCode  String?
  country     String?
  
  // Message et dédicace
  message     String?  @db.Text // Message personnel
  dedication  String?  // Dédier le don à quelqu'un
  isAnonymous Boolean  @default(false) // Rester anonyme
  
  // Consentements
  consentEmail Boolean @default(false)
  consentPhone Boolean @default(false)
  consentSMS   Boolean @default(false)
  consentMail  Boolean @default(false)
  
  // Statut de la soumission
  status      String   @default("pending") // pending, processing, completed, failed
  
  // Relations
  paymentIntent PaymentIntent?
  donation      Donation?
  subscription  Subscription?
  
  // Métadonnées
  ipAddress   String?  // Adresse IP du donateur
  userAgent   String?  // User agent du navigateur
  referrer    String?  // URL de provenance
  
  // Organisation (multi-tenant)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Timestamps
  submittedAt DateTime @default(now())
  completedAt DateTime?
  
  @@index([formId])
  @@index([donatorId])
  @@index([organizationId])
  @@index([status])
  @@index([submittedAt])
  @@map("donation_form_submissions")
}
```

**Champs obligatoires:** `id`, `formId`, `amount`, `currency`, `formData`, `email`, `status`, `organizationId`

---

## 3. Modèle PaymentIntent

Ce modèle représente une intention de paiement créée auprès d'une passerelle (Stripe, PayPal).

```prisma
model PaymentIntent {
  id          String   @id @default(cuid())
  
  // Soumission liée
  submissionId String  @unique
  submission   DonationFormSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  
  // Passerelle de paiement
  gateway     String   // stripe, paypal, moneris
  
  // ID externe (de la passerelle)
  externalId  String   // payment_intent_id (Stripe) ou order_id (PayPal)
  
  // Montant
  amount      Decimal  @db.Decimal(10, 2)
  currency    String   @default("CAD")
  
  // Statut du paiement
  status      String   @default("created") // created, processing, succeeded, failed, cancelled
  
  // Méthode de paiement
  paymentMethod String? // card, paypal, bank_transfer, etc.
  last4         String? // 4 derniers chiffres de la carte (si applicable)
  brand         String? // visa, mastercard, amex (si applicable)
  
  // Erreurs
  errorCode    String?
  errorMessage String?  @db.Text
  
  // Métadonnées de la passerelle
  metadata    Json?    // Données additionnelles de la passerelle
  
  // Organisation (multi-tenant)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  succeededAt DateTime?
  failedAt    DateTime?
  
  @@index([submissionId])
  @@index([externalId])
  @@index([organizationId])
  @@index([status])
  @@map("payment_intents")
}
```

**Champs obligatoires:** `id`, `submissionId`, `gateway`, `externalId`, `amount`, `currency`, `status`, `organizationId`

---

## 4. Modèle Subscription

Ce modèle représente un abonnement pour les dons récurrents.

```prisma
model Subscription {
  id          String   @id @default(cuid())
  
  // Donateur
  donatorId   String
  donator     Donator  @relation(fields: [donatorId], references: [id], onDelete: Cascade)
  
  // Formulaire
  formId      String
  form        DonationForm @relation(fields: [formId], references: [id], onDelete: Cascade)
  
  // Soumission initiale
  submissionId String  @unique
  submission   DonationFormSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  
  // Configuration
  amount      Decimal  @db.Decimal(10, 2)
  currency    String   @default("CAD")
  frequency   String   // monthly, quarterly, yearly
  
  // Passerelle de paiement
  gateway         String  // stripe, paypal
  subscriptionId  String  // ID externe (Stripe subscription ID)
  
  // Statut
  status      String   @default("active") // active, paused, cancelled, expired
  
  // Dates
  startDate       DateTime @default(now())
  nextPaymentDate DateTime
  endDate         DateTime?
  cancelledAt     DateTime?
  
  // Raison d'annulation
  cancellationReason String?
  
  // Relations
  donations   Donation[] // Tous les dons générés par cet abonnement
  
  // Organisation (multi-tenant)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([donatorId])
  @@index([formId])
  @@index([organizationId])
  @@index([status])
  @@index([nextPaymentDate])
  @@map("subscriptions")
}
```

**Champs obligatoires:** `id`, `donatorId`, `formId`, `submissionId`, `amount`, `currency`, `frequency`, `gateway`, `subscriptionId`, `status`, `nextPaymentDate`, `organizationId`

---

## 5. Mettre à Jour le Modèle Donation

Le modèle `Donation` existe déjà (créé en Phase 1), mais nous devons ajouter des champs pour lier aux formulaires et abonnements.

**Ajouter ces champs au modèle `Donation` existant:**

```prisma
// Lien vers le formulaire (si don via formulaire)
formId      String?
form        DonationForm? @relation(fields: [formId], references: [id], onDelete: SetNull)

// Lien vers la soumission (si don via formulaire)
submissionId String?  @unique
submission   DonationFormSubmission? @relation(fields: [submissionId], references: [id], onDelete: SetNull)

// Lien vers l'abonnement (si don récurrent)
subscriptionId String?
subscription   Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)

// Index à ajouter
@@index([formId])
@@index([subscriptionId])
```

---

## 6. Mettre à Jour les Relations

### Dans le modèle `Organization`, ajouter :

```prisma
donationForms        DonationForm[]
formSubmissions      DonationFormSubmission[]
paymentIntents       PaymentIntent[]
subscriptions        Subscription[]
```

### Dans le modèle `Donator`, ajouter :

```prisma
formSubmissions      DonationFormSubmission[]
subscriptions        Subscription[]
```

---

## 7. Enum pour les Statuts

**Ajouter ces enums avant les modèles:**

```prisma
enum FormStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum SubmissionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum PaymentStatus {
  CREATED
  PROCESSING
  SUCCEEDED
  FAILED
  CANCELLED
}

enum SubscriptionStatus {
  ACTIVE
  PAUSED
  CANCELLED
  EXPIRED
}
```

**Ensuite, remplacer les champs `String` par les enums:**
- `DonationForm.status` → `FormStatus`
- `DonationFormSubmission.status` → `SubmissionStatus`
- `PaymentIntent.status` → `PaymentStatus`
- `Subscription.status` → `SubscriptionStatus`

---

## 8. Exemple de Données JSON

### suggestedAmounts (DonationForm)

```json
[25, 50, 100, 250, 500, 1000]
```

### frequencies (DonationForm)

```json
["monthly", "quarterly", "yearly"]
```

### requiredFields (DonationForm)

```json
["email", "firstName", "lastName"]
```

### optionalFields (DonationForm)

```json
["phone", "address", "city", "province", "postalCode", "country", "message", "dedication"]
```

### customFields (DonationForm)

```json
[
  {
    "id": "company",
    "type": "text",
    "label": "Nom de l'entreprise",
    "placeholder": "Acme Inc.",
    "required": false
  },
  {
    "id": "hear_about_us",
    "type": "select",
    "label": "Comment avez-vous entendu parler de nous ?",
    "options": ["Réseaux sociaux", "Bouche à oreille", "Publicité", "Autre"],
    "required": true
  }
]
```

### formData (DonationFormSubmission)

```json
{
  "email": "john@example.com",
  "firstName": "John",
  "lastName": "Doe",
  "phone": "+1 514 555 1234",
  "message": "Merci pour votre travail !",
  "company": "Acme Inc.",
  "hear_about_us": "Réseaux sociaux"
}
```

---

## 9. Vérifications Importantes

Avant de finaliser, assurez-vous que :

- ✅ Les 4 nouveaux modèles sont ajoutés (DonationForm, DonationFormSubmission, PaymentIntent, Subscription)
- ✅ Les 4 enums sont ajoutés (FormStatus, SubmissionStatus, PaymentStatus, SubscriptionStatus)
- ✅ Le modèle Donation est mis à jour avec les nouveaux champs
- ✅ Toutes les relations sont bidirectionnelles
- ✅ Les contraintes `onDelete` sont correctes (Cascade ou SetNull selon le cas)
- ✅ Tous les index sont créés pour les champs fréquemment recherchés
- ✅ Les contraintes d'unicité sont respectées (slug, submissionId, etc.)
- ✅ Les champs JSON ont des exemples de structure

---

## 10. Commandes à Exécuter Après Modification

**NE PAS EXÉCUTER CES COMMANDES MAINTENANT.** Elles seront exécutées par Manus après vérification.

```bash
# 1. Générer la migration Prisma
npx prisma migrate dev --name add_donation_forms

# 2. Générer le client Prisma
npx prisma generate

# 3. Pousser vers la base de données (si pas de migration)
npx prisma db push
```

---

## 11. Résultat Attendu

Après cette étape, le fichier `schema.prisma` doit contenir :

- ✅ 4 nouveaux modèles (DonationForm, DonationFormSubmission, PaymentIntent, Subscription)
- ✅ 4 nouveaux enums (FormStatus, SubmissionStatus, PaymentStatus, SubscriptionStatus)
- ✅ Modèle Donation mis à jour avec liens vers formulaires et abonnements
- ✅ Toutes les relations bidirectionnelles dans Organization et Donator
- ✅ Tous les index et contraintes en place

---

## 12. Prochaine Étape

Une fois cette étape complétée et pushée, Manus vérifiera le schéma et préparera les instructions pour **2.1.2 - Interface de Gestion des Formulaires**.

---

## Référence Cahier des Charges

- Section 5.2.1 - Création de Formulaires Personnalisables
- Section 5.2.2 - Champs et Personnalisation
- Section 13.2 - Règles de Traitement des Paiements
