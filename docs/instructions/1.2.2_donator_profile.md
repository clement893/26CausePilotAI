# Instructions Détaillées pour Cursor - Étape 1.2.2

**Phase:** 1 - Fondations  
**Étape:** 1.2 - Module Base de Données Donateurs (Core)  
**Fonctionnalité:** 1.2.2 - Page de Profil Donateur (Vue Détaillée)  
**Prérequis:** Étape 1.2.1 complétée

---

## Contexte

Nous créons la page de profil détaillé d'un donateur individuel. Cette page doit afficher toutes les informations du donateur, son historique de dons complet, ses interactions, et permettre de gérer son profil. C'est une vue 360° du donateur.

**Référence cahier des charges:** Section 4.2.1 - Gestion des Profils Donateurs

---

## 1. Page Profil Donateur

**Créer:** `/apps/web/app/[locale]/dashboard/donateurs/[id]/page.tsx`

### Structure de la Page

La page doit contenir :

#### **Section 1 : Header du Profil**

Layout horizontal avec :

**Partie gauche :**
- **Avatar large** (120x120px)
  - Image si disponible
  - Initiales avec gradient si pas d'image
- **Nom complet** (grande taille)
- **Email** (avec icône et lien mailto)
- **Téléphone** (avec icône et lien tel)
- **Badges** :
  - Segment (VIP, Active, etc.)
  - Statut (Actif/Inactif)
  - Consentements (icônes email, phone, sms, mail)

**Partie droite :**
- Bouton "Modifier" (outline)
- Bouton "Envoyer un email" (gradient bleu-violet)
- Bouton menu (3 dots) avec :
  - Ajouter une note
  - Marquer comme VIP
  - Désactiver
  - Supprimer
  - Exporter le profil

#### **Section 2 : Statistiques Rapides (4 Cards)**

Cards horizontales avec icônes et valeurs :

1. **Total des Dons**
   - Icône : DollarSign
   - Valeur : $12,450.00 (formaté)
   - Label : "Total collecté"
   - Tendance : +15% vs année dernière

2. **Nombre de Dons**
   - Icône : Gift
   - Valeur : 24
   - Label : "Dons effectués"
   - Tendance : +3 ce mois

3. **Don Moyen**
   - Icône : TrendingUp
   - Valeur : $518.75
   - Label : "Montant moyen"
   - Tendance : +8% vs moyenne

4. **Score de Propension**
   - Icône : Target
   - Valeur : 87/100
   - Label : "Score d'engagement"
   - Barre de progression colorée

#### **Section 3 : Onglets de Contenu**

Tabs navigation avec 5 onglets :

1. **Vue d'ensemble** (Overview)
2. **Historique des dons** (Donations)
3. **Interactions** (Interactions)
4. **Notes** (Notes)
5. **Activité** (Activity)

---

### Onglet 1 : Vue d'ensemble

Layout en 2 colonnes :

**Colonne gauche (2/3) :**

**Card 1 : Informations Personnelles**
- Prénom
- Nom
- Email
- Téléphone
- Adresse complète (address, city, province, postalCode, country)
- Profession
- Employeur
- Secteur d'activité

**Card 2 : Préférences de Communication**
- Canal préféré (email, phone, sms, mail)
- Langue préférée (fr, en)
- Fréquence de communication (weekly, monthly, quarterly)
- Consentements (4 toggles avec dates) :
  - Email marketing
  - Appels téléphoniques
  - SMS
  - Courrier postal

**Card 3 : Intérêts et Causes**
- Liste des intérêts (tags cliquables)
- Bouton "Ajouter un intérêt"

**Card 4 : Champs Personnalisés**
- Affichage dynamique des champs JSON
- Bouton "Ajouter un champ"

**Colonne droite (1/3) :**

**Card 5 : Segmentation**
- Segment actuel (badge)
- Score de propension (barre)
- Bouton "Changer de segment"
- Historique des changements de segment

**Card 6 : Métriques de Dons**
- Premier don : Date
- Dernier don : Date (relative)
- Fréquence moyenne : X jours entre dons
- Plus gros don : Montant + date
- Campagnes supportées : Nombre + liste

**Card 7 : Timeline Récente**
- 5 dernières activités :
  - Don effectué
  - Email envoyé
  - Email ouvert
  - Profil mis à jour
  - Note ajoutée
- Bouton "Voir tout" → onglet Activité

---

### Onglet 2 : Historique des Dons

**Table de données** avec colonnes :
- Date (formatée)
- Campagne (lien vers la campagne)
- Montant (formaté en devise)
- Méthode de paiement (Stripe, PayPal, etc.)
- Statut (badge : Completed, Pending, Refunded)
- Reçu (bouton "Télécharger PDF")
- Actions (dropdown : Voir détails, Émettre remboursement)

**Fonctionnalités :**
- Tri par colonne
- Filtre par campagne
- Filtre par statut
- Filtre par date (range picker)
- Export CSV de l'historique
- Pagination

**Statistiques en haut :**
- Graphique en barres : Dons par mois (12 derniers mois)
- Graphique en ligne : Évolution du montant cumulé

**Empty state :**
Si aucun don : "Ce donateur n'a pas encore effectué de don. Invitez-le à contribuer !"

---

### Onglet 3 : Interactions

**Timeline verticale** avec toutes les interactions :

Types d'interactions :
- **Email envoyé** (icône Mail)
  - Sujet de l'email
  - Date d'envoi
  - Statut : Envoyé, Ouvert, Cliqué
  - Bouton "Voir l'email"
- **Email ouvert** (icône MailOpen)
  - Date d'ouverture
  - Nombre d'ouvertures
- **Lien cliqué** (icône MousePointer)
  - URL cliquée
  - Date du clic
- **Appel téléphonique** (icône Phone)
  - Date de l'appel
  - Durée
  - Notes
- **SMS envoyé** (icône MessageSquare)
  - Contenu du SMS
  - Date d'envoi
  - Statut
- **Formulaire rempli** (icône FileText)
  - Type de formulaire
  - Date de soumission

**Fonctionnalités :**
- Filtre par type d'interaction
- Filtre par date
- Recherche dans les interactions
- Bouton "Ajouter une interaction manuelle"

---

### Onglet 4 : Notes

**Liste de notes** avec :

**Chaque note affiche :**
- Avatar de l'auteur
- Nom de l'auteur
- Date de création (relative)
- Contenu de la note (markdown support)
- Bouton "Modifier" (si auteur)
- Bouton "Supprimer" (si auteur ou admin)

**Fonctionnalités :**
- Bouton "Ajouter une note" (en haut)
- Editor de notes avec markdown
- Épingler une note importante (sticky)
- Filtrer par auteur
- Recherche dans les notes

**Empty state :**
"Aucune note pour ce donateur. Ajoutez la première !"

---

### Onglet 5 : Activité

**Timeline complète** de toutes les activités :

Types d'activités :
- Profil créé
- Profil mis à jour (avec diff des changements)
- Don effectué
- Email envoyé/ouvert/cliqué
- SMS envoyé
- Appel effectué
- Note ajoutée
- Segment changé
- Statut changé (activé/désactivé)
- Consentement modifié

**Chaque activité affiche :**
- Icône selon le type
- Description de l'activité
- Auteur (utilisateur ou système)
- Date et heure (relative)
- Détails supplémentaires (expandable)

**Fonctionnalités :**
- Filtre par type d'activité
- Filtre par auteur
- Filtre par date
- Recherche dans les activités
- Export de l'historique

---

## 2. Page Édition du Profil

**Créer:** `/apps/web/app/[locale]/dashboard/donateurs/[id]/edit/page.tsx`

### Structure de la Page

Formulaire en plusieurs sections (similaire à la création) :

**Section 1 : Informations Personnelles**
- Tous les champs du profil
- Validation React Hook Form + Zod

**Section 2 : Préférences de Communication**
- Sélecteurs et toggles

**Section 3 : Intérêts et Segmentation**
- Multi-select pour intérêts
- Sélecteur de segment
- Score (lecture seule, calculé automatiquement)

**Section 4 : Champs Personnalisés**
- Éditeur JSON ou formulaire dynamique

**Actions :**
- Bouton "Annuler" (retour au profil)
- Bouton "Enregistrer" (gradient bleu-violet)
- Bouton "Supprimer le donateur" (destructif, en bas)

---

## 3. Modèles de Données Additionnels

Pour supporter l'historique et les interactions, nous devons ajouter des modèles au schéma Prisma.

### 3.1 Modèle Donation

**Ajouter dans:** `/packages/database/prisma/schema.prisma`

```prisma
model Donation {
  id          String   @id @default(cuid())
  
  // Montant
  amount      Decimal  @db.Decimal(10, 2)
  currency    String   @default("CAD")
  
  // Donateur
  donatorId   String
  donator     Donator  @relation(fields: [donatorId], references: [id], onDelete: Cascade)
  
  // Campagne (optionnel pour plus tard)
  campaignId  String?
  // campaign    Campaign? @relation(fields: [campaignId], references: [id])
  
  // Paiement
  paymentMethod String  // stripe, paypal, cash, check, etc.
  paymentId     String? // ID de transaction externe
  status        String  @default("completed") // completed, pending, refunded, failed
  
  // Reçu fiscal
  receiptNumber String? @unique
  receiptIssued Boolean @default(false)
  receiptUrl    String?
  
  // Métadonnées
  notes         String? @db.Text
  
  // Organisation (multi-tenant)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Timestamps
  donatedAt   DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([donatorId])
  @@index([campaignId])
  @@index([organizationId])
  @@index([donatedAt])
  @@index([status])
  @@map("donations")
}
```

### 3.2 Modèle Interaction

```prisma
model Interaction {
  id          String   @id @default(cuid())
  
  // Type d'interaction
  type        String   // email_sent, email_opened, email_clicked, sms_sent, phone_call, form_submitted
  
  // Donateur
  donatorId   String
  donator     Donator  @relation(fields: [donatorId], references: [id], onDelete: Cascade)
  
  // Détails
  subject     String?  // Pour emails
  content     String?  @db.Text // Contenu de l'interaction
  url         String?  // Pour liens cliqués
  duration    Int?     // Pour appels (en secondes)
  
  // Métadonnées
  metadata    Json?    // Données additionnelles
  
  // Organisation (multi-tenant)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Timestamps
  occurredAt  DateTime @default(now())
  createdAt   DateTime @default(now())
  
  @@index([donatorId])
  @@index([organizationId])
  @@index([type])
  @@index([occurredAt])
  @@map("interactions")
}
```

### 3.3 Modèle Note

```prisma
model Note {
  id          String   @id @default(cuid())
  
  // Contenu
  content     String   @db.Text
  isPinned    Boolean  @default(false)
  
  // Donateur
  donatorId   String
  donator     Donator  @relation(fields: [donatorId], references: [id], onDelete: Cascade)
  
  // Auteur
  authorId    String
  author      User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  
  // Organisation (multi-tenant)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([donatorId])
  @@index([authorId])
  @@index([organizationId])
  @@map("notes")
}
```

### 3.4 Modèle Activity

```prisma
model Activity {
  id          String   @id @default(cuid())
  
  // Type d'activité
  type        String   // profile_created, profile_updated, donation_made, etc.
  
  // Description
  description String   @db.Text
  
  // Détails (diff pour updates)
  details     Json?
  
  // Donateur (optionnel)
  donatorId   String?
  donator     Donator? @relation(fields: [donatorId], references: [id], onDelete: Cascade)
  
  // Auteur (utilisateur ou système)
  authorId    String?
  author      User?    @relation(fields: [authorId], references: [id], onDelete: SetNull)
  
  // Organisation (multi-tenant)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Timestamps
  occurredAt  DateTime @default(now())
  
  @@index([donatorId])
  @@index([authorId])
  @@index([organizationId])
  @@index([type])
  @@index([occurredAt])
  @@map("activities")
}
```

### 3.5 Mettre à Jour les Relations

**Dans le modèle `Donator`, ajouter :**

```prisma
donations    Donation[]
interactions Interaction[]
notes        Note[]
activities   Activity[]
```

**Dans le modèle `Organization`, ajouter :**

```prisma
donations    Donation[]
interactions Interaction[]
notes        Note[]
activities   Activity[]
```

**Dans le modèle `User`, ajouter :**

```prisma
notes        Note[]
activities   Activity[]
```

---

## 4. Actions Serveur

### 4.1 Action de Récupération du Profil

**Créer:** `/apps/web/app/actions/donators/get-donator.ts`

```typescript
"use server"

import { prisma } from "@/lib/prisma"
import { requireAuth } from "@/lib/auth/get-session"

export async function getDonatorAction(donatorId: string) {
  const session = await requireAuth()
  
  // Récupérer le donateur avec toutes ses relations
  const donator = await prisma.donator.findUnique({
    where: {
      id: donatorId,
      organizationId: session.user.organizationId,
    },
    include: {
      donations: {
        orderBy: { donatedAt: "desc" },
        take: 10, // Derniers 10 dons
      },
      interactions: {
        orderBy: { occurredAt: "desc" },
        take: 20, // Dernières 20 interactions
      },
      notes: {
        include: {
          author: {
            select: {
              id: true,
              firstName: true,
              lastName: true,
              avatar: true,
            },
          },
        },
        orderBy: [
          { isPinned: "desc" },
          { createdAt: "desc" },
        ],
      },
      activities: {
        include: {
          author: {
            select: {
              id: true,
              firstName: true,
              lastName: true,
            },
          },
        },
        orderBy: { occurredAt: "desc" },
        take: 50, // Dernières 50 activités
      },
    },
  })
  
  if (!donator) {
    throw new Error("Donateur introuvable")
  }
  
  return donator
}
```

### 4.2 Action de Mise à Jour du Profil

**Créer:** `/apps/web/app/actions/donators/update-donator.ts`

```typescript
"use server"

import { prisma } from "@/lib/prisma"
import { requireAuth } from "@/lib/auth/get-session"
import { revalidatePath } from "next/cache"

export async function updateDonatorAction(
  donatorId: string,
  data: UpdateDonatorInput
) {
  const session = await requireAuth()
  
  // Valider les données
  const validated = updateDonatorSchema.parse(data)
  
  // Récupérer l'ancien profil pour le diff
  const oldDonator = await prisma.donator.findUnique({
    where: { id: donatorId },
  })
  
  // Mettre à jour le donateur
  const donator = await prisma.donator.update({
    where: {
      id: donatorId,
      organizationId: session.user.organizationId,
    },
    data: validated,
  })
  
  // Créer une activité pour tracer la modification
  await prisma.activity.create({
    data: {
      type: "profile_updated",
      description: `Profil mis à jour par ${session.user.firstName} ${session.user.lastName}`,
      details: {
        changes: getChanges(oldDonator, donator),
      },
      donatorId: donator.id,
      authorId: session.user.id,
      organizationId: session.user.organizationId,
    },
  })
  
  // Revalider les pages
  revalidatePath(`/dashboard/donateurs/${donatorId}`)
  revalidatePath("/dashboard/donateurs")
  
  return { success: true, donator }
}

// Fonction helper pour calculer le diff
function getChanges(oldData: any, newData: any) {
  const changes: any = {}
  for (const key in newData) {
    if (oldData[key] !== newData[key]) {
      changes[key] = {
        from: oldData[key],
        to: newData[key],
      }
    }
  }
  return changes
}
```

### 4.3 Action d'Ajout de Note

**Créer:** `/apps/web/app/actions/donators/add-note.ts`

```typescript
"use server"

import { prisma } from "@/lib/prisma"
import { requireAuth } from "@/lib/auth/get-session"
import { revalidatePath } from "next/cache"

export async function addNoteAction(donatorId: string, content: string) {
  const session = await requireAuth()
  
  // Créer la note
  const note = await prisma.note.create({
    data: {
      content,
      donatorId,
      authorId: session.user.id,
      organizationId: session.user.organizationId,
    },
    include: {
      author: {
        select: {
          firstName: true,
          lastName: true,
          avatar: true,
        },
      },
    },
  })
  
  // Créer une activité
  await prisma.activity.create({
    data: {
      type: "note_added",
      description: `Note ajoutée par ${session.user.firstName} ${session.user.lastName}`,
      donatorId,
      authorId: session.user.id,
      organizationId: session.user.organizationId,
    },
  })
  
  // Revalider la page
  revalidatePath(`/dashboard/donateurs/${donatorId}`)
  
  return { success: true, note }
}
```

---

## 5. Composants Réutilisables

### 5.1 Composant DonatorHeader

**Créer:** `/apps/web/components/donators/DonatorHeader.tsx`

Header du profil avec avatar, nom, badges, et actions.

### 5.2 Composant DonatorStatsCards

**Créer:** `/apps/web/components/donators/DonatorStatsCards.tsx`

4 cartes de statistiques rapides.

### 5.3 Composant DonationHistoryTable

**Créer:** `/apps/web/components/donators/DonationHistoryTable.tsx`

Table de l'historique des dons avec tri et filtres.

### 5.4 Composant InteractionTimeline

**Créer:** `/apps/web/components/donators/InteractionTimeline.tsx`

Timeline verticale des interactions.

### 5.5 Composant NotesList

**Créer:** `/apps/web/components/donators/NotesList.tsx`

Liste des notes avec editor.

### 5.6 Composant ActivityTimeline

**Créer:** `/apps/web/components/donators/ActivityTimeline.tsx`

Timeline complète des activités.

---

## 6. Vérifications Importantes

Avant de finaliser, assurez-vous que :

- ✅ Les 4 nouveaux modèles sont ajoutés au schéma Prisma
- ✅ Les relations sont correctement définies
- ✅ La page de profil affiche toutes les informations
- ✅ Les 5 onglets fonctionnent
- ✅ La page d'édition permet de modifier le profil
- ✅ L'historique des dons s'affiche correctement
- ✅ Les interactions sont tracées
- ✅ Les notes peuvent être ajoutées/modifiées
- ✅ L'activité est enregistrée automatiquement
- ✅ Le design respecte le design system
- ✅ La page est responsive

---

## 7. Prochaine Étape

Une fois cette étape complétée, **l'Étape 1.2 (Module Base de Données Donateurs) sera terminée**.

Manus préparera ensuite un **récapitulatif de la Phase 1 (Fondations)** avant de passer à la **Phase 2 (Collecte)**.

---

## Référence Cahier des Charges

- Section 4.2.1 - Gestion des Profils Donateurs
- Section 4.2.3 - Historique et Traçabilité
- Section 13.1 - Règles de Gestion des Donateurs
