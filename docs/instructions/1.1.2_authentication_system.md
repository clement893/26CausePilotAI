# Instructions Détaillées pour Cursor - Étape 1.1.2

**Phase:** 1 - Fondations  
**Étape:** 1.1 - Module Administration & Sécurité  
**Fonctionnalité:** 1.1.2 - Système d'Authentification  
**Prérequis:** Étape 1.1.1 complétée (modèles de données créés)

---

## Contexte

Nous devons mettre en place un système d'authentification complet avec Next-Auth (Auth.js v5) qui supporte :
- Authentification par email/password
- Authentification OAuth (Google)
- Multi-tenant (isolation par organisation)
- Gestion des rôles et permissions
- 2FA obligatoire pour les administrateurs (future)

---

## 1. Configuration Next-Auth

### 1.1 Fichier de Configuration Principal

**Créer/Modifier:** `/apps/web/lib/auth.ts`

Ce fichier doit contenir la configuration complète de Next-Auth avec :

**Providers à configurer:**
1. **CredentialsProvider** - Pour l'authentification email/password
   - Valider l'email et le mot de passe
   - Vérifier que l'utilisateur est actif (`isActive: true`)
   - Vérifier que l'organisation est active (`organization.isActive: true`)
   - Hasher les mots de passe avec `bcrypt` (rounds: 10)

2. **GoogleProvider** - Pour l'authentification OAuth Google
   - Utiliser les variables d'environnement `GOOGLE_CLIENT_ID` et `GOOGLE_CLIENT_SECRET`
   - Créer automatiquement un utilisateur s'il n'existe pas
   - Lier l'utilisateur à une organisation par défaut ou demander la sélection

**Callbacks à implémenter:**

1. **`signIn` callback:**
   - Vérifier que l'utilisateur existe et est actif
   - Vérifier que l'organisation est active
   - Mettre à jour `lastLoginAt` dans la base de données
   - Retourner `true` si autorisé, `false` sinon

2. **`jwt` callback:**
   - Ajouter les informations utilisateur au token JWT :
     - `userId`: ID de l'utilisateur
     - `organizationId`: ID de l'organisation
     - `role`: Rôle de l'utilisateur (ADMIN, DIRECTOR, MANAGER)
     - `email`: Email de l'utilisateur
     - `firstName`, `lastName`: Nom complet

3. **`session` callback:**
   - Transférer les informations du JWT vers la session
   - La session doit contenir :
     ```typescript
     session.user = {
       id: token.userId,
       email: token.email,
       firstName: token.firstName,
       lastName: token.lastName,
       role: token.role,
       organizationId: token.organizationId
     }
     ```

**Pages personnalisées:**
- `signIn`: `/auth/login`
- `signOut`: `/auth/logout`
- `error`: `/auth/error`
- `verifyRequest`: `/auth/verify-request`
- `newUser`: `/auth/welcome` (pour l'onboarding)

**Session:**
- Strategy: `jwt` (pour la scalabilité)
- MaxAge: 30 jours (2592000 secondes)

**Autres paramètres:**
- `secret`: Variable d'environnement `NEXTAUTH_SECRET`
- `debug`: `true` en développement, `false` en production

---

## 2. Types TypeScript pour la Session

**Créer:** `/apps/web/types/next-auth.d.ts`

Étendre les types Next-Auth pour inclure nos champs personnalisés :

```typescript
import { DefaultSession, DefaultUser } from "next-auth"
import { JWT, DefaultJWT } from "next-auth/jwt"
import { Role } from "@prisma/client"

declare module "next-auth" {
  interface Session {
    user: {
      id: string
      role: Role
      organizationId: string
      firstName?: string | null
      lastName?: string | null
    } & DefaultSession["user"]
  }

  interface User extends DefaultUser {
    role: Role
    organizationId: string
    firstName?: string | null
    lastName?: string | null
  }
}

declare module "next-auth/jwt" {
  interface JWT extends DefaultJWT {
    userId: string
    role: Role
    organizationId: string
    firstName?: string | null
    lastName?: string | null
  }
}
```

---

## 3. Route API Next-Auth

**Créer:** `/apps/web/app/api/auth/[...nextauth]/route.ts`

Ce fichier doit exporter les handlers Next-Auth pour Next.js 13+ App Router :

```typescript
import { handlers } from "@/lib/auth"

export const { GET, POST } = handlers
```

---

## 4. Variables d'Environnement

**Ajouter dans:** `/apps/web/.env` et `/apps/web/.env.example`

```env
# Next-Auth Configuration
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=your-super-secret-key-change-this-in-production

# Google OAuth (optionnel pour le moment)
GOOGLE_CLIENT_ID=your-google-client-id
GOOGLE_CLIENT_SECRET=your-google-client-secret

# Database (déjà présent normalement)
DATABASE_URL=postgresql://user:password@localhost:5432/causepilotai
```

**Important:** Générer un `NEXTAUTH_SECRET` sécurisé avec :
```bash
openssl rand -base64 32
```

---

## 5. Utilitaires d'Authentification

### 5.1 Helper pour Obtenir la Session Serveur

**Créer:** `/apps/web/lib/auth/get-session.ts`

Fonction utilitaire pour obtenir la session côté serveur dans les Server Components et Route Handlers :

```typescript
import { auth } from "@/lib/auth"

export async function getServerSession() {
  return await auth()
}

export async function requireAuth() {
  const session = await getServerSession()
  if (!session) {
    throw new Error("Unauthorized")
  }
  return session
}

export async function requireRole(allowedRoles: Role[]) {
  const session = await requireAuth()
  if (!allowedRoles.includes(session.user.role)) {
    throw new Error("Forbidden")
  }
  return session
}
```

### 5.2 Hook pour Client Components

**Créer:** `/apps/web/hooks/use-session.ts`

Hook personnalisé pour accéder à la session dans les Client Components :

```typescript
"use client"

import { useSession as useNextAuthSession } from "next-auth/react"

export function useSession() {
  return useNextAuthSession()
}

export function useUser() {
  const { data: session } = useSession()
  return session?.user
}

export function useOrganization() {
  const user = useUser()
  return user?.organizationId
}
```

---

## 6. Middleware de Protection des Routes

**Créer:** `/apps/web/middleware.ts`

Middleware Next.js pour protéger les routes authentifiées :

```typescript
import { withAuth } from "next-auth/middleware"
import { NextResponse } from "next/server"

export default withAuth(
  function middleware(req) {
    // Routes publiques - pas de vérification
    const publicRoutes = ["/", "/auth/login", "/auth/register", "/auth/error"]
    if (publicRoutes.includes(req.nextUrl.pathname)) {
      return NextResponse.next()
    }

    // Vérifier que l'utilisateur est authentifié
    const token = req.nextauth.token
    if (!token) {
      return NextResponse.redirect(new URL("/auth/login", req.url))
    }

    // Routes admin - vérifier le rôle
    if (req.nextUrl.pathname.startsWith("/admin")) {
      if (token.role !== "ADMIN") {
        return NextResponse.redirect(new URL("/dashboard", req.url))
      }
    }

    return NextResponse.next()
  },
  {
    callbacks: {
      authorized: ({ token }) => !!token,
    },
  }
)

export const config = {
  matcher: [
    /*
     * Match all request paths except:
     * - _next/static (static files)
     * - _next/image (image optimization files)
     * - favicon.ico (favicon file)
     * - public folder
     */
    "/((?!_next/static|_next/image|favicon.ico|public).*)",
  ],
}
```

---

## 7. Fonctions Utilitaires de Hashing

**Créer:** `/apps/web/lib/auth/password.ts`

Fonctions pour hasher et vérifier les mots de passe :

```typescript
import bcrypt from "bcryptjs"

const SALT_ROUNDS = 10

export async function hashPassword(password: string): Promise<string> {
  return bcrypt.hash(password, SALT_ROUNDS)
}

export async function verifyPassword(
  password: string,
  hashedPassword: string
): Promise<boolean> {
  return bcrypt.compare(password, hashedPassword)
}
```

---

## 8. Provider Session pour l'App

**Modifier:** `/apps/web/app/layout.tsx`

Envelopper l'application avec le `SessionProvider` :

```typescript
import { SessionProvider } from "next-auth/react"

export default function RootLayout({ children }) {
  return (
    <html>
      <body>
        <SessionProvider>
          {children}
        </SessionProvider>
      </body>
    </html>
  )
}
```

---

## 9. Dépendances NPM à Installer

**Exécuter dans `/apps/web`:**

```bash
npm install next-auth@beta bcryptjs
npm install -D @types/bcryptjs
```

**Note:** Utiliser `next-auth@beta` pour Auth.js v5 compatible avec Next.js 14+

---

## 10. Vérifications Importantes

Avant de finaliser, assurez-vous que :

- ✅ Le fichier `/lib/auth.ts` contient la configuration complète avec les 2 providers
- ✅ Les callbacks `signIn`, `jwt` et `session` sont correctement implémentés
- ✅ Les types TypeScript sont étendus dans `/types/next-auth.d.ts`
- ✅ La route API `/api/auth/[...nextauth]/route.ts` est créée
- ✅ Les variables d'environnement sont ajoutées dans `.env`
- ✅ Les utilitaires `getServerSession`, `requireAuth`, `requireRole` sont créés
- ✅ Le hook `useSession` est créé pour les Client Components
- ✅ Le middleware de protection des routes est en place
- ✅ Les fonctions de hashing de mot de passe sont créées
- ✅ Le `SessionProvider` enveloppe l'application
- ✅ Les dépendances NPM sont installées

---

## 11. Tests à Effectuer Après Implémentation

**Manus vérifiera que :**

1. La route `/api/auth/signin` est accessible
2. La route `/api/auth/signout` est accessible
3. Le middleware protège correctement les routes `/dashboard/*`
4. Les types TypeScript sont corrects (pas d'erreurs de compilation)
5. Les variables d'environnement sont correctement configurées

---

## 12. Prochaine Étape

Une fois cette étape complétée et pushée, **Manus préparera les instructions pour l'étape suivante : 1.1.3 - Pages d'Authentification (Login, Register, etc.)**.

---

## Référence Cahier des Charges

- Section 11.2.1 - Gestion des Utilisateurs et Permissions
- Section 13.4 - Règles de Sécurité
- Section 15.4 - Sécurité et Conformité
