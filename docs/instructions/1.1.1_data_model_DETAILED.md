# Instructions Détaillées pour Cursor - Étape 1.1.1

**Phase:** 1 - Fondations  
**Étape:** 1.1 - Module Administration & Sécurité  
**Fonctionnalité:** 1.1.1 - Modèle de données Utilisateurs, Organisations & Rôles  
**Fichier à modifier:** `/packages/database/prisma/schema.prisma`

---

## Contexte

Nous construisons une plateforme de collecte de dons philanthropiques multi-tenant. Chaque organisation (ONG, association) aura sa propre instance isolée avec ses propres utilisateurs et donateurs. Le système doit supporter 3 niveaux de rôles : Admin, Director, Manager.

---

## 1. Créer l'Enum `Role`

Ajoutez cet enum **avant** les modèles dans le fichier `schema.prisma`.

```prisma
enum Role {
  ADMIN       // Administrateur système - accès complet
  DIRECTOR    // Gestionnaire Philanthropique (Directeur) - lecture seule sur campagnes
  MANAGER     // Gestionnaire de Campagnes - accès complet aux campagnes
}
```

**Référence cahier des charges:** Section 2.4 - Matrice des Permissions

---

## 2. Créer le Modèle `Organization`

Ce modèle représente une organisation (ONG, association) qui utilise la plateforme. Il est au cœur de l'architecture multi-tenant.

```prisma
model Organization {
  id          String   @id @default(cuid())
  name        String   // Nom de l'organisation (ex: "Croix-Rouge Québec")
  slug        String   @unique // URL-friendly identifier (ex: "croix-rouge-quebec")
  
  // Informations de branding
  logo        String?  // URL du logo de l'organisation
  website     String?  // Site web officiel
  description String?  @db.Text // Description de la mission
  
  // Coordonnées
  email       String?  // Email de contact principal
  phone       String?  // Téléphone principal
  address     String?  // Adresse physique complète
  city        String?
  province    String?
  postalCode  String?
  country     String   @default("CA") // Code pays ISO (CA, US, FR, etc.)
  
  // Paramètres système
  timezone    String   @default("America/Toronto") // Fuseau horaire
  currency    String   @default("CAD") // Devise par défaut (CAD, USD, EUR)
  language    String   @default("fr") // Langue par défaut (fr, en)
  
  // Statut
  isActive    Boolean  @default(true) // Organisation active ou suspendue
  
  // Relations
  users       User[]   // Utilisateurs de cette organisation
  donators    Donator[] // Donateurs de cette organisation
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([slug])
  @@index([isActive])
  @@map("organizations")
}
```

**Champs obligatoires:** `id`, `name`, `slug`, `country`, `timezone`, `currency`, `language`, `isActive`

**Référence cahier des charges:** Section 13.1 - Architecture multi-tenant

---

## 3. Mettre à Jour le Modèle `User`

Modifiez le modèle `User` existant pour l'intégrer avec les organisations et les rôles. **Conservez tous les champs existants** et ajoutez les nouveaux.

```prisma
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  
  // Informations personnelles
  firstName     String?
  lastName      String?
  phone         String?
  avatar        String?   // URL de l'avatar
  
  // Authentification
  password      String?   // Hash du mot de passe (si auth locale)
  
  // Organisation et rôle
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  role           Role      @default(MANAGER)
  
  // Statut
  isActive      Boolean   @default(true)
  lastLoginAt   DateTime?
  
  // Relations existantes (à conserver)
  accounts      Account[]
  sessions      Session[]
  
  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([email])
  @@index([organizationId])
  @@index([role])
  @@map("users")
}
```

**Nouveaux champs ajoutés:**
- `firstName`, `lastName`, `phone`, `avatar`
- `organizationId` (obligatoire)
- `organization` (relation)
- `role` (enum)
- `isActive`, `lastLoginAt`

**Référence cahier des charges:** Section 2 - Utilisateurs et Rôles

---

## 4. Créer le Modèle `Donator`

Ce modèle représente un donateur dans la base de données. C'est le cœur du CRM philanthropique.

```prisma
model Donator {
  id            String   @id @default(cuid())
  
  // Informations personnelles
  email         String   // Email principal du donateur
  firstName     String?
  lastName      String?
  phone         String?
  
  // Adresse
  address       String?
  city          String?
  province      String?
  postalCode    String?
  country       String?
  
  // Informations professionnelles
  profession    String?
  employer      String?
  sector        String?  // Secteur d'activité
  
  // Préférences de communication
  preferredChannel String? // email, phone, sms, mail
  preferredLanguage String @default("fr") // fr, en
  communicationFrequency String? // weekly, monthly, quarterly
  
  // Intérêts et causes
  interests     String[] // Array de causes d'intérêt
  
  // Champs personnalisés (JSON pour flexibilité)
  customFields  Json?    // Champs additionnels spécifiques à l'organisation
  
  // Consentements RGPD/PIPEDA
  consentEmail  Boolean  @default(false)
  consentPhone  Boolean  @default(false)
  consentSMS    Boolean  @default(false)
  consentMail   Boolean  @default(false)
  consentDate   DateTime?
  
  // Segmentation automatique (sera calculé par l'IA)
  segment       String?  // VIP, Active, Inactive, New, etc.
  score         Int      @default(0) // Score de propension au don (0-100)
  
  // Métriques de dons (seront calculées)
  totalDonations Decimal @default(0) @db.Decimal(10, 2)
  donationCount  Int     @default(0)
  averageDonation Decimal @default(0) @db.Decimal(10, 2)
  lastDonationDate DateTime?
  firstDonationDate DateTime?
  
  // Statut
  isActive      Boolean  @default(true)
  
  // Organisation (multi-tenant)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@unique([email, organizationId]) // Un email unique par organisation
  @@index([email])
  @@index([organizationId])
  @@index([segment])
  @@index([lastDonationDate])
  @@map("donators")
}
```

**Champs obligatoires:** `id`, `email`, `organizationId`, `preferredLanguage`, `isActive`

**Référence cahier des charges:** Section 4.2.1 - Gestion des Profils Donateurs

---

## 5. Vérifications Importantes

Avant de finaliser, assurez-vous que :

1. **Les relations sont bidirectionnelles:**
   - `Organization` → `users: User[]`
   - `User` → `organization: Organization`
   - `Organization` → `donators: Donator[]`
   - `Donator` → `organization: Organization`

2. **Les contraintes `onDelete` sont correctes:**
   - Si une `Organization` est supprimée, tous ses `User` et `Donator` doivent être supprimés (`onDelete: Cascade`)

3. **Les index sont créés pour les champs fréquemment recherchés:**
   - `Organization`: `slug`, `isActive`
   - `User`: `email`, `organizationId`, `role`
   - `Donator`: `email`, `organizationId`, `segment`, `lastDonationDate`

4. **Les contraintes d'unicité sont respectées:**
   - `Organization.slug` → `@unique`
   - `User.email` → `@unique`
   - `Donator.email + organizationId` → `@@unique([email, organizationId])`

---

## 6. Commandes à Exécuter Après Modification

**NE PAS EXÉCUTER CES COMMANDES MAINTENANT.** Elles seront exécutées par Manus après vérification.

```bash
# 1. Générer la migration Prisma
npx prisma migrate dev --name add_organizations_and_donators

# 2. Générer le client Prisma
npx prisma generate

# 3. Pousser vers la base de données (si pas de migration)
npx prisma db push
```

---

## 7. Résultat Attendu

Après cette étape, le fichier `schema.prisma` doit contenir :

- ✅ L'enum `Role` avec 3 valeurs (ADMIN, DIRECTOR, MANAGER)
- ✅ Le modèle `Organization` complet avec tous les champs
- ✅ Le modèle `User` mis à jour avec les nouveaux champs et relations
- ✅ Le modèle `Donator` complet avec tous les champs
- ✅ Toutes les relations bidirectionnelles correctement définies
- ✅ Tous les index et contraintes en place

---

## 8. Prochaine Étape

Une fois que vous aurez appliqué ces changements et pushé vers GitHub, **Manus vérifiera le schéma** et préparera les instructions pour l'étape suivante : **1.1.2 - Système d'Authentification**.
