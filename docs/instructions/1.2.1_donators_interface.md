# Instructions Détaillées pour Cursor - Étape 1.2.1

**Phase:** 1 - Fondations  
**Étape:** 1.2 - Module Base de Données Donateurs (Core)  
**Fonctionnalité:** 1.2.1 - Interface de Gestion des Donateurs (Liste et Recherche)  
**Prérequis:** Étape 1.1 complétée (Administration & Sécurité)

---

## Contexte

Nous créons le CRM central de la plateforme : la base de données donateurs. Cette interface doit permettre de visualiser, rechercher, filtrer et gérer tous les donateurs de l'organisation. C'est l'équivalent de la page `/dashboard/base-donateur/donateurs` mentionnée par l'utilisateur.

**Référence cahier des charges:** Section 4 - Module Base de Données Donateurs

---

## 1. Page Liste des Donateurs

**Créer:** `/apps/web/app/[locale]/dashboard/donateurs/page.tsx`

### Structure de la Page

La page doit contenir :

1. **Header de page** avec :
   - Titre : "Base de Données Donateurs"
   - Breadcrumb : Dashboard > Donateurs
   - **Statistiques rapides** (4 KPI cards) :
     - Total donateurs actifs
     - Nouveaux ce mois
     - Taux de rétention
     - Valeur moyenne par donateur
   - Bouton "Ajouter un donateur" (gradient bleu-violet)
   - Bouton "Importer CSV" (outline)
   - Bouton "Exporter" (outline)

2. **Barre de recherche et filtres avancés** :
   - **Input de recherche globale** (nom, email, téléphone)
   - **Filtres rapides** (chips cliquables) :
     - Tous
     - VIP
     - Actifs
     - Inactifs
     - Nouveaux (< 30 jours)
   - **Bouton "Filtres avancés"** qui ouvre un drawer avec :
     - Plage de montant total de dons (min-max)
     - Plage de nombre de dons (min-max)
     - Date de dernier don (range picker)
     - Segment (VIP, Active, Inactive, New, etc.)
     - Préférence de communication (email, phone, sms, mail)
     - Intérêts (multi-select)
     - Consentements (email, phone, sms, mail)
   - **Bouton "Réinitialiser"**

3. **Table de données interactive** avec colonnes :
   - **Checkbox** (sélection multiple)
   - **Avatar + Nom complet** (firstName + lastName)
     - Avatar généré avec initiales si pas d'image
     - Gradient de couleur basé sur le nom
   - **Email** (avec icône si consentEmail)
   - **Téléphone** (avec icône si consentPhone)
   - **Segment** (badge coloré)
     - VIP : Gradient bleu-violet
     - Active : Gradient vert-cyan
     - Inactive : Gris
     - New : Gradient orange-rose
   - **Total dons** (formaté en devise)
   - **Nombre de dons**
   - **Dernier don** (date relative : "il y a 2 jours")
   - **Score** (barre de progression 0-100)
   - **Actions** (dropdown menu) :
     - Voir le profil
     - Modifier
     - Envoyer un email
     - Ajouter une note
     - Marquer comme VIP
     - Désactiver
     - Supprimer

4. **Actions en vrac** (barre sticky en bas quand sélection) :
   - "X donateurs sélectionnés"
   - Bouton "Envoyer un email"
   - Bouton "Ajouter à un segment"
   - Bouton "Exporter la sélection"
   - Bouton "Supprimer"
   - Bouton "Annuler la sélection"

5. **Pagination avancée** :
   - Sélecteur : 10, 25, 50, 100, 500 par page
   - Navigation : First, Previous, [1] [2] [3] ... [10], Next, Last
   - Affichage : "Showing 1 to 25 of 1,247 donateurs"
   - Jump to page : Input pour aller à une page spécifique

### Fonctionnalités

- **Recherche en temps réel** avec debounce (300ms)
- **Filtres combinables** (tous les filtres peuvent être actifs simultanément)
- **Tri par colonne** (nom, email, total dons, nombre dons, dernier don, score)
- **Ordre de tri** (ASC/DESC) avec indicateur visuel
- **Sélection multiple** :
  - Checkbox "Tout sélectionner" dans le header
  - Sélection individuelle par ligne
  - Compteur de sélection
- **Actions en vrac** avec confirmation pour actions destructives
- **Loading states** :
  - Skeleton loader pendant le chargement initial
  - Spinner pendant les recherches/filtres
- **Empty states** :
  - Aucun donateur : Illustration + CTA "Ajouter votre premier donateur"
  - Aucun résultat de recherche : "Aucun donateur trouvé. Essayez d'autres filtres."
- **Persistence des filtres** dans l'URL (query params)
- **Export CSV** des résultats filtrés

### Design

Utiliser le composant de table avancée des pages DÉMO (`/demodatatable`) comme référence :

- **Table moderne** avec :
  - Header sticky
  - Hover effects sur les lignes
  - Zebra striping (lignes alternées)
  - Responsive (scroll horizontal sur mobile)
- **Badges gradient** pour les segments
- **Barres de progression** pour le score
- **Icônes Lucide React** pour les actions
- **Tooltips** sur les icônes
- **Animations** smooth pour les interactions

---

## 2. Composants Réutilisables

### 2.1 Composant DonatorTable

**Créer:** `/apps/web/components/donators/DonatorTable.tsx`

Table de données avec :
- Toutes les colonnes définies ci-dessus
- Tri par colonne
- Sélection multiple
- Actions par ligne
- Pagination
- Loading states
- Empty states

**Props:**
```typescript
interface DonatorTableProps {
  donators: Donator[]
  total: number
  page: number
  limit: number
  onPageChange: (page: number) => void
  onLimitChange: (limit: number) => void
  onSort: (column: string, order: "asc" | "desc") => void
  onSelect: (donatorIds: string[]) => void
  selectedIds: string[]
  isLoading?: boolean
}
```

### 2.2 Composant DonatorFilters

**Créer:** `/apps/web/components/donators/DonatorFilters.tsx`

Barre de filtres avec :
- Input de recherche
- Filtres rapides (chips)
- Bouton "Filtres avancés"
- Drawer de filtres avancés
- Bouton "Réinitialiser"

**Props:**
```typescript
interface DonatorFiltersProps {
  onSearch: (query: string) => void
  onFilterChange: (filters: DonatorFilters) => void
  activeFilters: DonatorFilters
}

interface DonatorFilters {
  search?: string
  segment?: string[]
  minTotalDonations?: number
  maxTotalDonations?: number
  minDonationCount?: number
  maxDonationCount?: number
  lastDonationFrom?: Date
  lastDonationTo?: Date
  preferredChannel?: string[]
  interests?: string[]
  consents?: string[]
}
```

### 2.3 Composant DonatorKPICards

**Créer:** `/apps/web/components/donators/DonatorKPICards.tsx`

4 cartes de statistiques rapides :
- Total donateurs actifs (avec icône Users)
- Nouveaux ce mois (avec icône UserPlus)
- Taux de rétention (avec icône TrendingUp)
- Valeur moyenne par donateur (avec icône DollarSign)

Chaque carte avec :
- Gradient subtle en fond
- Icône avec gradient
- Valeur principale (grande)
- Label (petit)
- Badge de tendance (+12%, +8%, etc.)

### 2.4 Composant SegmentBadge

**Créer:** `/apps/web/components/donators/SegmentBadge.tsx`

Badge coloré pour afficher le segment :
- VIP : Gradient bleu-violet
- Active : Gradient vert-cyan
- Inactive : Gris
- New : Gradient orange-rose
- Custom : Couleur personnalisée

### 2.5 Composant ScoreBar

**Créer:** `/apps/web/components/donators/ScoreBar.tsx`

Barre de progression pour le score (0-100) :
- Couleur selon le score :
  - 0-30 : Rouge
  - 31-60 : Orange
  - 61-80 : Jaune
  - 81-100 : Vert
- Tooltip avec le score exact

### 2.6 Composant DonatorAvatar

**Créer:** `/apps/web/components/donators/DonatorAvatar.tsx`

Avatar avec :
- Image si disponible
- Initiales si pas d'image (firstName[0] + lastName[0])
- Gradient de couleur basé sur le nom (hash)
- Tailles : sm, md, lg, xl

### 2.7 Composant BulkActionsBar

**Créer:** `/apps/web/components/donators/BulkActionsBar.tsx`

Barre sticky en bas de l'écran quand sélection active :
- Compteur de sélection
- Boutons d'actions
- Animation d'entrée/sortie

---

## 3. Actions Serveur

### 3.1 Action de Récupération des Donateurs

**Créer:** `/apps/web/app/actions/donators/get-donators.ts`

```typescript
"use server"

import { prisma } from "@/lib/prisma"
import { requireAuth } from "@/lib/auth/get-session"

export async function getDonatorsAction(params: GetDonatorsParams) {
  // Vérifier l'authentification
  const session = await requireAuth()
  
  // Extraire les paramètres
  const {
    search = "",
    segment = [],
    minTotalDonations,
    maxTotalDonations,
    minDonationCount,
    maxDonationCount,
    lastDonationFrom,
    lastDonationTo,
    preferredChannel = [],
    interests = [],
    consents = [],
    page = 1,
    limit = 25,
    sortBy = "createdAt",
    sortOrder = "desc",
  } = params
  
  // Construire le where clause
  const where: any = {
    organizationId: session.user.organizationId,
  }
  
  // Recherche globale
  if (search) {
    where.OR = [
      { firstName: { contains: search, mode: "insensitive" } },
      { lastName: { contains: search, mode: "insensitive" } },
      { email: { contains: search, mode: "insensitive" } },
      { phone: { contains: search, mode: "insensitive" } },
    ]
  }
  
  // Filtre par segment
  if (segment.length > 0) {
    where.segment = { in: segment }
  }
  
  // Filtre par montant total
  if (minTotalDonations !== undefined || maxTotalDonations !== undefined) {
    where.totalDonations = {}
    if (minTotalDonations !== undefined) {
      where.totalDonations.gte = minTotalDonations
    }
    if (maxTotalDonations !== undefined) {
      where.totalDonations.lte = maxTotalDonations
    }
  }
  
  // Filtre par nombre de dons
  if (minDonationCount !== undefined || maxDonationCount !== undefined) {
    where.donationCount = {}
    if (minDonationCount !== undefined) {
      where.donationCount.gte = minDonationCount
    }
    if (maxDonationCount !== undefined) {
      where.donationCount.lte = maxDonationCount
    }
  }
  
  // Filtre par date de dernier don
  if (lastDonationFrom || lastDonationTo) {
    where.lastDonationDate = {}
    if (lastDonationFrom) {
      where.lastDonationDate.gte = lastDonationFrom
    }
    if (lastDonationTo) {
      where.lastDonationDate.lte = lastDonationTo
    }
  }
  
  // Filtre par canal préféré
  if (preferredChannel.length > 0) {
    where.preferredChannel = { in: preferredChannel }
  }
  
  // Filtre par intérêts
  if (interests.length > 0) {
    where.interests = { hasSome: interests }
  }
  
  // Filtre par consentements
  if (consents.includes("email")) {
    where.consentEmail = true
  }
  if (consents.includes("phone")) {
    where.consentPhone = true
  }
  if (consents.includes("sms")) {
    where.consentSMS = true
  }
  if (consents.includes("mail")) {
    where.consentMail = true
  }
  
  // Récupérer les donateurs
  const [donators, total] = await Promise.all([
    prisma.donator.findMany({
      where,
      skip: (page - 1) * limit,
      take: limit,
      orderBy: { [sortBy]: sortOrder },
      select: {
        id: true,
        email: true,
        firstName: true,
        lastName: true,
        phone: true,
        segment: true,
        totalDonations: true,
        donationCount: true,
        averageDonation: true,
        lastDonationDate: true,
        score: true,
        consentEmail: true,
        consentPhone: true,
        consentSMS: true,
        consentMail: true,
        isActive: true,
        createdAt: true,
      },
    }),
    prisma.donator.count({ where }),
  ])
  
  return {
    donators,
    pagination: {
      page,
      limit,
      total,
      totalPages: Math.ceil(total / limit),
    },
  }
}
```

### 3.2 Action de Récupération des KPIs

**Créer:** `/apps/web/app/actions/donators/get-kpis.ts`

```typescript
"use server"

import { prisma } from "@/lib/prisma"
import { requireAuth } from "@/lib/auth/get-session"

export async function getDonatorsKPIsAction() {
  const session = await requireAuth()
  
  // Date il y a 30 jours
  const thirtyDaysAgo = new Date()
  thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30)
  
  // Date il y a 60 jours (pour calculer les tendances)
  const sixtyDaysAgo = new Date()
  sixtyDaysAgo.setDate(sixtyDaysAgo.getDate() - 60)
  
  // Récupérer les statistiques
  const [
    totalActive,
    totalActivePrevious,
    newThisMonth,
    newPreviousMonth,
    averageDonation,
    averageDonationPrevious,
  ] = await Promise.all([
    // Total donateurs actifs (actuellement)
    prisma.donator.count({
      where: {
        organizationId: session.user.organizationId,
        isActive: true,
      },
    }),
    // Total donateurs actifs (il y a 30 jours)
    prisma.donator.count({
      where: {
        organizationId: session.user.organizationId,
        isActive: true,
        createdAt: { lte: thirtyDaysAgo },
      },
    }),
    // Nouveaux ce mois
    prisma.donator.count({
      where: {
        organizationId: session.user.organizationId,
        createdAt: { gte: thirtyDaysAgo },
      },
    }),
    // Nouveaux le mois précédent
    prisma.donator.count({
      where: {
        organizationId: session.user.organizationId,
        createdAt: {
          gte: sixtyDaysAgo,
          lt: thirtyDaysAgo,
        },
      },
    }),
    // Valeur moyenne par donateur (actuellement)
    prisma.donator.aggregate({
      where: {
        organizationId: session.user.organizationId,
        isActive: true,
      },
      _avg: { totalDonations: true },
    }),
    // Valeur moyenne par donateur (il y a 30 jours)
    prisma.donator.aggregate({
      where: {
        organizationId: session.user.organizationId,
        isActive: true,
        lastDonationDate: { lte: thirtyDaysAgo },
      },
      _avg: { totalDonations: true },
    }),
  ])
  
  // Calculer les tendances (pourcentage de changement)
  const activeTrend = totalActivePrevious > 0
    ? ((totalActive - totalActivePrevious) / totalActivePrevious) * 100
    : 0
  
  const newTrend = newPreviousMonth > 0
    ? ((newThisMonth - newPreviousMonth) / newPreviousMonth) * 100
    : 0
  
  const avgDonation = averageDonation._avg.totalDonations || 0
  const avgDonationPrev = averageDonationPrevious._avg.totalDonations || 0
  const avgTrend = avgDonationPrev > 0
    ? ((Number(avgDonation) - Number(avgDonationPrev)) / Number(avgDonationPrev)) * 100
    : 0
  
  // Calculer le taux de rétention (simplifié)
  // Rétention = donateurs avec au moins 2 dons / total donateurs
  const retentionCount = await prisma.donator.count({
    where: {
      organizationId: session.user.organizationId,
      donationCount: { gte: 2 },
    },
  })
  
  const retentionRate = totalActive > 0
    ? (retentionCount / totalActive) * 100
    : 0
  
  return {
    totalActive: {
      value: totalActive,
      trend: activeTrend,
    },
    newThisMonth: {
      value: newThisMonth,
      trend: newTrend,
    },
    retentionRate: {
      value: retentionRate,
      trend: 0, // TODO: calculer la tendance
    },
    averageDonation: {
      value: avgDonation,
      trend: avgTrend,
    },
  }
}
```

### 3.3 Action d'Export CSV

**Créer:** `/apps/web/app/actions/donators/export-csv.ts`

```typescript
"use server"

import { prisma } from "@/lib/prisma"
import { requireAuth } from "@/lib/auth/get-session"

export async function exportDonatorsCSVAction(donatorIds?: string[]) {
  const session = await requireAuth()
  
  // Construire le where clause
  const where: any = {
    organizationId: session.user.organizationId,
  }
  
  // Si IDs spécifiques fournis, filtrer
  if (donatorIds && donatorIds.length > 0) {
    where.id = { in: donatorIds }
  }
  
  // Récupérer tous les donateurs
  const donators = await prisma.donator.findMany({
    where,
    orderBy: { lastName: "asc" },
  })
  
  // Générer le CSV
  const headers = [
    "Prénom",
    "Nom",
    "Email",
    "Téléphone",
    "Segment",
    "Total Dons",
    "Nombre de Dons",
    "Dernier Don",
    "Score",
  ]
  
  const rows = donators.map((d) => [
    d.firstName || "",
    d.lastName || "",
    d.email,
    d.phone || "",
    d.segment || "",
    d.totalDonations.toString(),
    d.donationCount.toString(),
    d.lastDonationDate?.toISOString().split("T")[0] || "",
    d.score.toString(),
  ])
  
  const csv = [
    headers.join(","),
    ...rows.map((row) => row.join(",")),
  ].join("\n")
  
  return { csv, filename: `donateurs-${new Date().toISOString().split("T")[0]}.csv` }
}
```

---

## 4. Route API

**Créer:** `/apps/web/app/api/donators/route.ts`

Route API pour la recherche et les filtres (alternative aux Server Actions) :

```typescript
import { NextRequest, NextResponse } from "next/server"
import { getDonatorsAction } from "@/app/actions/donators/get-donators"

export async function GET(request: NextRequest) {
  try {
    const searchParams = request.nextUrl.searchParams
    
    // Extraire tous les paramètres
    const params = {
      search: searchParams.get("search") || undefined,
      segment: searchParams.getAll("segment"),
      minTotalDonations: searchParams.get("minTotalDonations")
        ? Number(searchParams.get("minTotalDonations"))
        : undefined,
      maxTotalDonations: searchParams.get("maxTotalDonations")
        ? Number(searchParams.get("maxTotalDonations"))
        : undefined,
      // ... autres paramètres
      page: Number(searchParams.get("page") || "1"),
      limit: Number(searchParams.get("limit") || "25"),
      sortBy: searchParams.get("sortBy") || "createdAt",
      sortOrder: (searchParams.get("sortOrder") || "desc") as "asc" | "desc",
    }
    
    const result = await getDonatorsAction(params)
    
    return NextResponse.json(result)
  } catch (error) {
    console.error("Error fetching donators:", error)
    return NextResponse.json(
      { error: "Failed to fetch donators" },
      { status: 500 }
    )
  }
}
```

---

## 5. Structure des Fichiers à Créer

```
/apps/web/
├── app/
│   ├── [locale]/
│   │   └── dashboard/
│   │       └── donateurs/
│   │           └── page.tsx
│   ├── actions/
│   │   └── donators/
│   │       ├── get-donators.ts
│   │       ├── get-kpis.ts
│   │       └── export-csv.ts
│   └── api/
│       └── donators/
│           └── route.ts
└── components/
    └── donators/
        ├── DonatorTable.tsx
        ├── DonatorFilters.tsx
        ├── DonatorKPICards.tsx
        ├── SegmentBadge.tsx
        ├── ScoreBar.tsx
        ├── DonatorAvatar.tsx
        └── BulkActionsBar.tsx
```

---

## 6. Dépendances NPM à Installer

```bash
npm install date-fns
```

Pour le formatage des dates relatives ("il y a 2 jours").

---

## 7. Vérifications Importantes

Avant de finaliser, assurez-vous que :

- ✅ La page liste des donateurs est créée
- ✅ Les 4 KPI cards affichent les statistiques
- ✅ La recherche fonctionne en temps réel
- ✅ Les filtres rapides fonctionnent
- ✅ Le drawer de filtres avancés fonctionne
- ✅ Le tri par colonne fonctionne
- ✅ La sélection multiple fonctionne
- ✅ Les actions en vrac fonctionnent
- ✅ La pagination fonctionne
- ✅ L'export CSV fonctionne
- ✅ Le design respecte le design system
- ✅ La page est responsive

---

## 8. Prochaine Étape

Une fois cette étape complétée, Manus préparera les instructions pour **1.2.2 - Page de Profil Donateur (Vue Détaillée)**.

---

## Référence Cahier des Charges

- Section 4.2.1 - Gestion des Profils Donateurs
- Section 4.2.2 - Recherche et Segmentation Avancées
- Section 15.1 - Performance (recherche < 3 sec)
