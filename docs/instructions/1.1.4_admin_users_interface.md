# Instructions Détaillées pour Cursor - Étape 1.1.4

**Phase:** 1 - Fondations  
**Étape:** 1.1 - Module Administration & Sécurité  
**Fonctionnalité:** 1.1.4 - Interface d'Administration (Gestion des Utilisateurs)  
**Prérequis:** Étapes 1.1.1, 1.1.2 et 1.1.3 complétées

---

## Contexte

Nous devons créer l'interface d'administration pour gérer les utilisateurs de l'organisation. Cette interface doit permettre de lister, créer, modifier, désactiver et supprimer des utilisateurs, tout en respectant les permissions basées sur les rôles.

**Permissions (selon cahier des charges section 2.4):**
- **ADMIN** : Accès complet (CRUD)
- **DIRECTOR** : Lecture seule
- **MANAGER** : Aucun accès

---

## 1. Page Liste des Utilisateurs

**Créer:** `/apps/web/app/[locale]/admin/users/page.tsx`

### Structure de la Page

La page doit contenir :

1. **Header de page** avec :
   - Titre : "Gestion des Utilisateurs"
   - Breadcrumb : Admin > Utilisateurs
   - Bouton "Ajouter un utilisateur" (visible uniquement pour ADMIN)
   - Compteur : "X utilisateurs actifs"

2. **Barre de filtres et recherche** :
   - Input de recherche (nom, email)
   - Filtre par rôle (All, Admin, Director, Manager)
   - Filtre par statut (All, Active, Inactive)
   - Bouton "Réinitialiser les filtres"

3. **Table de données** avec colonnes :
   - Avatar + Nom complet (firstName + lastName)
   - Email
   - Rôle (badge coloré)
   - Statut (badge actif/inactif)
   - Dernière connexion (lastLoginAt)
   - Actions (boutons Edit, Deactivate/Activate, Delete)

4. **Pagination** :
   - 10, 25, 50, 100 par page
   - Navigation Previous/Next
   - Affichage "Showing X to Y of Z users"

### Fonctionnalités

- **Recherche en temps réel** sur nom et email
- **Filtres combinables** (rôle + statut)
- **Tri par colonne** (nom, email, rôle, dernière connexion)
- **Actions en vrac** (sélection multiple) :
  - Désactiver les utilisateurs sélectionnés
  - Supprimer les utilisateurs sélectionnés
- **Confirmation modals** pour les actions destructives
- **Loading states** pendant les requêtes
- **Empty state** si aucun utilisateur

### Design

- Utiliser le composant `DataTable` des pages DÉMO
- Header avec gradient subtle
- Badges colorés par rôle :
  - ADMIN : Gradient bleu-violet
  - DIRECTOR : Gradient vert-cyan
  - MANAGER : Gradient orange-rose
- Actions avec icônes Lucide React
- Hover effects sur les lignes

---

## 2. Page Création d'Utilisateur

**Créer:** `/apps/web/app/[locale]/admin/users/new/page.tsx`

### Structure de la Page

La page doit contenir :

1. **Header de page** avec :
   - Titre : "Ajouter un utilisateur"
   - Breadcrumb : Admin > Utilisateurs > Nouveau
   - Bouton "Retour" vers la liste

2. **Formulaire de création** dans une Card avec sections :

   **Section 1 : Informations personnelles**
   - Prénom (firstName) - requis
   - Nom (lastName) - requis
   - Email - requis, unique
   - Téléphone (phone) - optionnel
   - Avatar URL - optionnel (ou upload futur)

   **Section 2 : Authentification**
   - Mot de passe - requis, avec strength indicator
   - Confirmer mot de passe - requis
   - Checkbox "Envoyer un email d'invitation" (optionnel)

   **Section 3 : Rôle et permissions**
   - Sélecteur de rôle (ADMIN, DIRECTOR, MANAGER)
   - Description du rôle sélectionné (permissions)
   - Toggle "Utilisateur actif" (isActive) - default true

3. **Actions du formulaire** :
   - Bouton "Annuler" (retour à la liste)
   - Bouton "Créer l'utilisateur" (gradient bleu-violet)

### Fonctionnalités

- **Validation côté client** avec React Hook Form + Zod
- **Vérification d'unicité email** (afficher erreur si existe)
- **Password strength indicator**
- **Preview des permissions** selon le rôle sélectionné
- **Toast notification** après création réussie
- **Redirection** vers la liste après succès

### Validation

```typescript
const createUserSchema = z.object({
  firstName: z.string().min(2, "Prénom trop court"),
  lastName: z.string().min(2, "Nom trop court"),
  email: z.string().email("Email invalide"),
  phone: z.string().optional(),
  password: z
    .string()
    .min(8, "Minimum 8 caractères")
    .regex(/[A-Z]/, "Doit contenir une majuscule")
    .regex(/[a-z]/, "Doit contenir une minuscule")
    .regex(/[0-9]/, "Doit contenir un chiffre"),
  confirmPassword: z.string(),
  role: z.enum(["ADMIN", "DIRECTOR", "MANAGER"]),
  isActive: z.boolean().default(true),
  sendInvitation: z.boolean().optional(),
}).refine((data) => data.password === data.confirmPassword, {
  message: "Les mots de passe ne correspondent pas",
  path: ["confirmPassword"],
})
```

---

## 3. Page Édition d'Utilisateur

**Créer:** `/apps/web/app/[locale]/admin/users/[id]/edit/page.tsx`

### Structure de la Page

Similaire à la page de création, mais :

1. **Header** : "Modifier l'utilisateur"
2. **Formulaire pré-rempli** avec les données existantes
3. **Section mot de passe optionnelle** :
   - Checkbox "Modifier le mot de passe"
   - Si coché, afficher les champs password + confirm
4. **Section informations supplémentaires** :
   - Date de création (createdAt) - lecture seule
   - Dernière connexion (lastLoginAt) - lecture seule
   - Dernière modification (updatedAt) - lecture seule

### Fonctionnalités

- **Chargement des données** depuis l'API
- **Validation** identique à la création
- **Mot de passe optionnel** (ne pas modifier si vide)
- **Toast notification** après modification réussie
- **Bouton "Supprimer l'utilisateur"** (destructif, en bas)

---

## 4. Page Profil Utilisateur (Vue Détaillée)

**Créer:** `/apps/web/app/[locale]/admin/users/[id]/page.tsx`

### Structure de la Page

La page doit contenir :

1. **Header de page** avec :
   - Avatar large + Nom complet
   - Badge de rôle
   - Badge de statut (actif/inactif)
   - Boutons : "Modifier", "Désactiver/Activer", "Supprimer"

2. **Sections d'informations** dans des Cards :

   **Card 1 : Informations personnelles**
   - Email
   - Téléphone
   - Rôle
   - Statut

   **Card 2 : Activité**
   - Date de création
   - Dernière connexion
   - Nombre de connexions (futur)
   - Dernière modification

   **Card 3 : Permissions**
   - Liste des permissions selon le rôle
   - Tableau de la matrice des permissions (section 2.4)

   **Card 4 : Historique d'activité** (futur)
   - Timeline des dernières actions
   - Logs d'audit

---

## 5. Actions Serveur

### 5.1 Action de Création

**Créer:** `/apps/web/app/actions/admin/users/create.ts`

```typescript
"use server"

import { prisma } from "@/lib/prisma"
import { hashPassword } from "@/lib/auth/password"
import { requireRole } from "@/lib/auth/get-session"
import { revalidatePath } from "next/cache"

export async function createUserAction(data: CreateUserInput) {
  // Vérifier que l'utilisateur courant est ADMIN
  await requireRole(["ADMIN"])
  
  // Valider les données
  const validated = createUserSchema.parse(data)
  
  // Vérifier que l'email n'existe pas
  const existingUser = await prisma.user.findUnique({
    where: { email: validated.email },
  })
  
  if (existingUser) {
    return { error: "Cet email est déjà utilisé" }
  }
  
  // Récupérer l'organisation de l'utilisateur courant
  const session = await requireAuth()
  
  // Hasher le mot de passe
  const hashedPassword = await hashPassword(validated.password)
  
  // Créer l'utilisateur
  const user = await prisma.user.create({
    data: {
      email: validated.email,
      firstName: validated.firstName,
      lastName: validated.lastName,
      phone: validated.phone,
      password: hashedPassword,
      organizationId: session.user.organizationId,
      role: validated.role,
      isActive: validated.isActive,
    },
  })
  
  // TODO: Envoyer email d'invitation si sendInvitation = true
  
  // Revalider la page
  revalidatePath("/admin/users")
  
  return { success: true, userId: user.id }
}
```

### 5.2 Action de Mise à Jour

**Créer:** `/apps/web/app/actions/admin/users/update.ts`

```typescript
"use server"

import { prisma } from "@/lib/prisma"
import { hashPassword } from "@/lib/auth/password"
import { requireRole } from "@/lib/auth/get-session"
import { revalidatePath } from "next/cache"

export async function updateUserAction(userId: string, data: UpdateUserInput) {
  // Vérifier que l'utilisateur courant est ADMIN
  await requireRole(["ADMIN"])
  
  // Valider les données
  const validated = updateUserSchema.parse(data)
  
  // Préparer les données à mettre à jour
  const updateData: any = {
    firstName: validated.firstName,
    lastName: validated.lastName,
    phone: validated.phone,
    role: validated.role,
    isActive: validated.isActive,
  }
  
  // Si mot de passe fourni, le hasher
  if (validated.password) {
    updateData.password = await hashPassword(validated.password)
  }
  
  // Mettre à jour l'utilisateur
  const user = await prisma.user.update({
    where: { id: userId },
    data: updateData,
  })
  
  // Revalider les pages
  revalidatePath("/admin/users")
  revalidatePath(`/admin/users/${userId}`)
  
  return { success: true, userId: user.id }
}
```

### 5.3 Action de Suppression

**Créer:** `/apps/web/app/actions/admin/users/delete.ts`

```typescript
"use server"

import { prisma } from "@/lib/prisma"
import { requireRole } from "@/lib/auth/get-session"
import { revalidatePath } from "next/cache"

export async function deleteUserAction(userId: string) {
  // Vérifier que l'utilisateur courant est ADMIN
  const session = await requireRole(["ADMIN"])
  
  // Empêcher la suppression de soi-même
  if (userId === session.user.id) {
    return { error: "Vous ne pouvez pas supprimer votre propre compte" }
  }
  
  // Supprimer l'utilisateur
  await prisma.user.delete({
    where: { id: userId },
  })
  
  // Revalider la page
  revalidatePath("/admin/users")
  
  return { success: true }
}
```

### 5.4 Action de Changement de Statut

**Créer:** `/apps/web/app/actions/admin/users/toggle-status.ts`

```typescript
"use server"

import { prisma } from "@/lib/prisma"
import { requireRole } from "@/lib/auth/get-session"
import { revalidatePath } from "next/cache"

export async function toggleUserStatusAction(userId: string) {
  // Vérifier que l'utilisateur courant est ADMIN
  const session = await requireRole(["ADMIN"])
  
  // Empêcher la désactivation de soi-même
  if (userId === session.user.id) {
    return { error: "Vous ne pouvez pas désactiver votre propre compte" }
  }
  
  // Récupérer l'utilisateur
  const user = await prisma.user.findUnique({
    where: { id: userId },
  })
  
  if (!user) {
    return { error: "Utilisateur introuvable" }
  }
  
  // Inverser le statut
  const updatedUser = await prisma.user.update({
    where: { id: userId },
    data: { isActive: !user.isActive },
  })
  
  // Revalider les pages
  revalidatePath("/admin/users")
  revalidatePath(`/admin/users/${userId}`)
  
  return { success: true, isActive: updatedUser.isActive }
}
```

---

## 6. Composants Réutilisables

### 6.1 Composant UserTable

**Créer:** `/apps/web/components/admin/users/UserTable.tsx`

Table de données avec :
- Colonnes configurables
- Tri par colonne
- Sélection multiple (checkboxes)
- Actions par ligne (Edit, Deactivate, Delete)
- Pagination
- Empty state

### 6.2 Composant UserFilters

**Créer:** `/apps/web/components/admin/users/UserFilters.tsx`

Barre de filtres avec :
- Input de recherche
- Select pour rôle
- Select pour statut
- Bouton reset

### 6.3 Composant UserForm

**Créer:** `/apps/web/components/admin/users/UserForm.tsx`

Formulaire réutilisable pour création et édition avec :
- Toutes les sections
- Validation React Hook Form
- Password strength indicator
- Role selector avec descriptions
- Actions (Cancel, Submit)

### 6.4 Composant RoleBadge

**Créer:** `/apps/web/components/admin/users/RoleBadge.tsx`

Badge coloré pour afficher le rôle :
- ADMIN : Gradient bleu-violet
- DIRECTOR : Gradient vert-cyan
- MANAGER : Gradient orange-rose

### 6.5 Composant StatusBadge

**Créer:** `/apps/web/components/admin/users/StatusBadge.tsx`

Badge pour afficher le statut :
- Active : Vert
- Inactive : Gris

### 6.6 Composant DeleteUserModal

**Créer:** `/apps/web/components/admin/users/DeleteUserModal.tsx`

Modal de confirmation pour suppression avec :
- Message d'avertissement
- Input de confirmation (taper "DELETE")
- Boutons Cancel et Delete

---

## 7. Routes API (optionnelles)

Si besoin de routes API pour les filtres et recherche :

**Créer:** `/apps/web/app/api/admin/users/route.ts`

```typescript
import { NextRequest, NextResponse } from "next/server"
import { prisma } from "@/lib/prisma"
import { requireRole } from "@/lib/auth/get-session"

export async function GET(request: NextRequest) {
  // Vérifier les permissions
  const session = await requireRole(["ADMIN", "DIRECTOR"])
  
  // Récupérer les query params
  const searchParams = request.nextUrl.searchParams
  const search = searchParams.get("search") || ""
  const role = searchParams.get("role") || "all"
  const status = searchParams.get("status") || "all"
  const page = parseInt(searchParams.get("page") || "1")
  const limit = parseInt(searchParams.get("limit") || "10")
  
  // Construire le where clause
  const where: any = {
    organizationId: session.user.organizationId,
  }
  
  if (search) {
    where.OR = [
      { firstName: { contains: search, mode: "insensitive" } },
      { lastName: { contains: search, mode: "insensitive" } },
      { email: { contains: search, mode: "insensitive" } },
    ]
  }
  
  if (role !== "all") {
    where.role = role
  }
  
  if (status !== "all") {
    where.isActive = status === "active"
  }
  
  // Récupérer les utilisateurs
  const [users, total] = await Promise.all([
    prisma.user.findMany({
      where,
      skip: (page - 1) * limit,
      take: limit,
      orderBy: { createdAt: "desc" },
      select: {
        id: true,
        email: true,
        firstName: true,
        lastName: true,
        phone: true,
        avatar: true,
        role: true,
        isActive: true,
        lastLoginAt: true,
        createdAt: true,
      },
    }),
    prisma.user.count({ where }),
  ])
  
  return NextResponse.json({
    users,
    pagination: {
      page,
      limit,
      total,
      totalPages: Math.ceil(total / limit),
    },
  })
}
```

---

## 8. Structure des Fichiers à Créer

```
/apps/web/
├── app/
│   ├── [locale]/
│   │   └── admin/
│   │       └── users/
│   │           ├── page.tsx (liste)
│   │           ├── new/
│   │           │   └── page.tsx (création)
│   │           └── [id]/
│   │               ├── page.tsx (vue détaillée)
│   │               └── edit/
│   │                   └── page.tsx (édition)
│   ├── actions/
│   │   └── admin/
│   │       └── users/
│   │           ├── create.ts
│   │           ├── update.ts
│   │           ├── delete.ts
│   │           └── toggle-status.ts
│   └── api/
│       └── admin/
│           └── users/
│               └── route.ts
└── components/
    └── admin/
        └── users/
            ├── UserTable.tsx
            ├── UserFilters.tsx
            ├── UserForm.tsx
            ├── RoleBadge.tsx
            ├── StatusBadge.tsx
            └── DeleteUserModal.tsx
```

---

## 9. Vérifications Importantes

Avant de finaliser, assurez-vous que :

- ✅ Les 4 pages admin sont créées (liste, new, edit, view)
- ✅ Les 6 composants réutilisables sont créés
- ✅ Les 4 actions serveur sont implémentées
- ✅ Les permissions sont vérifiées (requireRole)
- ✅ La recherche et les filtres fonctionnent
- ✅ La pagination fonctionne
- ✅ Les actions destructives ont des confirmations
- ✅ Les toast notifications sont affichées
- ✅ Le design respecte le design system
- ✅ Les pages sont responsive

---

## 10. Prochaine Étape

Une fois cette étape complétée, **l'Étape 1.1 (Module Administration & Sécurité) sera terminée**. 

Manus préparera ensuite les instructions pour **l'Étape 1.2 - Module Base de Données Donateurs (Core)**.

---

## Référence Cahier des Charges

- Section 2.4 - Matrice des Permissions
- Section 11.2.1 - Gestion des Utilisateurs et Permissions
- Section 15.2 - Utilisabilité
