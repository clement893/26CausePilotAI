# Instructions Détaillées pour Cursor - Étape 2.1.2

**Phase:** 2 - Collecte  
**Étape:** 2.1 - Module Formulaires de Don  
**Fonctionnalité:** 2.1.2 - Interface de Gestion des Formulaires  
**Prérequis:** Étape 2.1.1 complétée

---

## Contexte

Nous créons l'interface pour lister, gérer et analyser les formulaires de don. Cette page permet aux administrateurs de voir tous leurs formulaires, leurs performances, et d'effectuer des actions (créer, modifier, dupliquer, archiver, supprimer).

**Référence cahier des charges:** Section 5.2.1 - Création de Formulaires Personnalisables

---

## 1. Page Liste des Formulaires

**Créer:** `/apps/web/app/[locale]/dashboard/formulaires/page.tsx`

### Structure de la Page

**Header avec:**
- Titre : "Formulaires de Don"
- Breadcrumb : Dashboard > Formulaires
- **4 KPI Cards** (statistiques globales) :
  - Total collecté (tous formulaires)
  - Nombre total de dons
  - Taux de conversion moyen
  - Nombre de formulaires actifs
- Bouton "Créer un formulaire" (gradient bleu-violet)

**Barre de filtres:**
- **Input de recherche** (nom du formulaire)
- **Filtres rapides** (chips) :
  - Tous
  - Publiés
  - Brouillons
  - Archivés
- **Tri** (dropdown) :
  - Plus récent
  - Plus ancien
  - Plus performant (montant collecté)
  - Alphabétique

**Table de données:**

Colonnes :
- **Nom** (avec icône de statut)
  - Titre du formulaire
  - Slug (petit texte gris)
- **Statut** (badge coloré)
  - Published : Vert
  - Draft : Jaune
  - Archived : Gris
- **Montant Collecté** (formaté en devise)
- **Nombre de Dons**
- **Taux de Conversion** (%)
  - Formule : (submissionCount / viewCount) * 100
  - Barre de progression colorée
- **Créé le** (date relative)
- **Actions** (dropdown menu) :
  - Voir les statistiques
  - Modifier
  - Dupliquer
  - Copier le lien
  - Archiver/Désarchiver
  - Supprimer

**Fonctionnalités:**
- Recherche en temps réel (debounce 300ms)
- Filtres par statut
- Tri par colonne
- Pagination (10/25/50 par page)
- Loading states (skeleton)
- Empty states :
  - Aucun formulaire : "Créez votre premier formulaire de don"
  - Aucun résultat : "Aucun formulaire trouvé"

---

## 2. Page Statistiques d'un Formulaire

**Créer:** `/apps/web/app/[locale]/dashboard/formulaires/[id]/stats/page.tsx`

### Structure de la Page

**Header:**
- Titre du formulaire
- Breadcrumb : Dashboard > Formulaires > [Nom] > Statistiques
- Badge de statut
- Boutons :
  - "Voir le formulaire" (ouvre dans nouvel onglet)
  - "Modifier"
  - Menu (...)

**Section 1 : KPIs (4 cards)**
1. **Montant Total Collecté**
   - Valeur + tendance (vs période précédente)
   - Icône DollarSign avec gradient
2. **Nombre de Dons**
   - Valeur + tendance
   - Icône Gift
3. **Taux de Conversion**
   - Pourcentage + barre de progression
   - Icône Target
4. **Montant Moyen par Don**
   - Valeur + tendance
   - Icône TrendingUp

**Section 2 : Graphiques**

**Graphique 1 : Évolution des Dons**
- Type : Line chart
- Axe X : Dates (30 derniers jours)
- Axe Y : Montant collecté
- Données : Montant par jour

**Graphique 2 : Distribution des Montants**
- Type : Bar chart
- Axe X : Tranches de montants (0-25, 25-50, 50-100, 100-250, 250-500, 500+)
- Axe Y : Nombre de dons
- Permet de voir quels montants sont les plus populaires

**Graphique 3 : Taux de Conversion par Source**
- Type : Pie chart
- Données : Provenance des donateurs (direct, réseaux sociaux, email, etc.)
- Extrait du champ `referrer` dans les submissions

**Section 3 : Top Donateurs**
- Liste des 10 plus gros donateurs pour ce formulaire
- Avatar + Nom + Montant total + Nombre de dons
- Lien vers le profil du donateur

**Section 4 : Dons Récents**
- Table des 20 derniers dons
- Colonnes : Date, Donateur, Montant, Statut
- Lien vers "Voir tous les dons"

---

## 3. Composants Réutilisables

### 3.1 Composant FormTable

**Créer:** `/apps/web/components/forms/FormTable.tsx`

Table de données avec toutes les colonnes et actions.

**Props:**
```typescript
interface FormTableProps {
  forms: DonationForm[]
  total: number
  page: number
  limit: number
  onPageChange: (page: number) => void
  onLimitChange: (limit: number) => void
  onSort: (column: string, order: "asc" | "desc") => void
  isLoading?: boolean
}
```

### 3.2 Composant FormKPICards

**Créer:** `/apps/web/components/forms/FormKPICards.tsx`

4 cartes de statistiques avec icônes gradient et tendances.

**Props:**
```typescript
interface FormKPICardsProps {
  totalCollected: number
  totalDonations: number
  averageConversion: number
  activeForms: number
  trends?: {
    collected: number
    donations: number
    conversion: number
    forms: number
  }
}
```

### 3.3 Composant FormStatusBadge

**Créer:** `/apps/web/components/forms/FormStatusBadge.tsx`

Badge coloré pour le statut du formulaire.

**Props:**
```typescript
interface FormStatusBadgeProps {
  status: "DRAFT" | "PUBLISHED" | "ARCHIVED"
}
```

Couleurs :
- DRAFT : Jaune (bg-yellow-500/10, text-yellow-500)
- PUBLISHED : Vert (bg-green-500/10, text-green-500)
- ARCHIVED : Gris (bg-gray-500/10, text-gray-500)

### 3.4 Composant FormFilters

**Créer:** `/apps/web/components/forms/FormFilters.tsx`

Barre de recherche et filtres rapides.

**Props:**
```typescript
interface FormFiltersProps {
  onSearch: (query: string) => void
  onFilterChange: (status: string | null) => void
  onSortChange: (sort: string) => void
  activeStatus: string | null
  activeSort: string
}
```

### 3.5 Composant ConversionBar

**Créer:** `/apps/web/components/forms/ConversionBar.tsx`

Barre de progression pour le taux de conversion avec couleur selon le taux.

**Props:**
```typescript
interface ConversionBarProps {
  rate: number // 0-100
  showLabel?: boolean
}
```

Couleurs selon le taux :
- 0-5% : Rouge
- 5-10% : Orange
- 10-20% : Jaune
- 20%+ : Vert

### 3.6 Composant FormStatsCharts

**Créer:** `/apps/web/components/forms/FormStatsCharts.tsx`

Tous les graphiques pour la page de statistiques.

Utiliser une bibliothèque de graphiques comme **Recharts** ou **Chart.js**.

---

## 4. Actions Serveur

### 4.1 Action de Récupération des Formulaires

**Créer:** `/apps/web/app/actions/forms/get-forms.ts`

```typescript
"use server"

import { prisma } from "@/lib/prisma"
import { requireAuth } from "@/lib/auth/get-session"

export async function getFormsAction(params: GetFormsParams) {
  const session = await requireAuth()
  
  const {
    search = "",
    status = null,
    page = 1,
    limit = 25,
    sortBy = "createdAt",
    sortOrder = "desc",
  } = params
  
  // Construire le where clause
  const where: any = {
    organizationId: session.user.organizationId,
  }
  
  // Recherche par nom
  if (search) {
    where.OR = [
      { title: { contains: search, mode: "insensitive" } },
      { slug: { contains: search, mode: "insensitive" } },
    ]
  }
  
  // Filtre par statut
  if (status) {
    where.status = status
  }
  
  // Récupérer les formulaires
  const [forms, total] = await Promise.all([
    prisma.donationForm.findMany({
      where,
      skip: (page - 1) * limit,
      take: limit,
      orderBy: { [sortBy]: sortOrder },
      select: {
        id: true,
        title: true,
        slug: true,
        status: true,
        totalCollected: true,
        donationCount: true,
        viewCount: true,
        submissionCount: true,
        conversionRate: true,
        createdAt: true,
        updatedAt: true,
      },
    }),
    prisma.donationForm.count({ where }),
  ])
  
  return {
    forms,
    pagination: {
      page,
      limit,
      total,
      totalPages: Math.ceil(total / limit),
    },
  }
}
```

### 4.2 Action de Récupération des KPIs Globaux

**Créer:** `/apps/web/app/actions/forms/get-global-kpis.ts`

```typescript
"use server"

import { prisma } from "@/lib/prisma"
import { requireAuth } from "@/lib/auth/get-session"

export async function getGlobalFormKPIsAction() {
  const session = await requireAuth()
  
  // Récupérer les statistiques globales
  const [totalCollected, totalDonations, activeForms, averageConversion] = await Promise.all([
    // Somme de tous les montants collectés
    prisma.donationForm.aggregate({
      where: { organizationId: session.user.organizationId },
      _sum: { totalCollected: true },
    }),
    // Somme de tous les dons
    prisma.donationForm.aggregate({
      where: { organizationId: session.user.organizationId },
      _sum: { donationCount: true },
    }),
    // Nombre de formulaires actifs (publiés)
    prisma.donationForm.count({
      where: {
        organizationId: session.user.organizationId,
        status: "PUBLISHED",
      },
    }),
    // Taux de conversion moyen
    prisma.donationForm.aggregate({
      where: { organizationId: session.user.organizationId },
      _avg: { conversionRate: true },
    }),
  ])
  
  return {
    totalCollected: totalCollected._sum.totalCollected || 0,
    totalDonations: totalDonations._sum.donationCount || 0,
    activeForms,
    averageConversion: averageConversion._avg.conversionRate || 0,
  }
}
```

### 4.3 Action de Récupération des Statistiques d'un Formulaire

**Créer:** `/apps/web/app/actions/forms/get-form-stats.ts`

```typescript
"use server"

import { prisma } from "@/lib/prisma"
import { requireAuth } from "@/lib/auth/get-session"

export async function getFormStatsAction(formId: string) {
  const session = await requireAuth()
  
  // Récupérer le formulaire
  const form = await prisma.donationForm.findUnique({
    where: {
      id: formId,
      organizationId: session.user.organizationId,
    },
    include: {
      submissions: {
        where: { status: "COMPLETED" },
        orderBy: { submittedAt: "desc" },
        take: 20,
        include: {
          donator: {
            select: {
              id: true,
              firstName: true,
              lastName: true,
              email: true,
            },
          },
        },
      },
    },
  })
  
  if (!form) {
    throw new Error("Formulaire introuvable")
  }
  
  // Calculer les données pour les graphiques
  // (évolution des dons, distribution des montants, etc.)
  // ...
  
  return {
    form,
    // ... autres données
  }
}
```

### 4.4 Action de Duplication de Formulaire

**Créer:** `/apps/web/app/actions/forms/duplicate-form.ts`

```typescript
"use server"

import { prisma } from "@/lib/prisma"
import { requireAuth } from "@/lib/auth/get-session"
import { revalidatePath } from "next/cache"

export async function duplicateFormAction(formId: string) {
  const session = await requireAuth()
  
  // Récupérer le formulaire original
  const original = await prisma.donationForm.findUnique({
    where: {
      id: formId,
      organizationId: session.user.organizationId,
    },
  })
  
  if (!original) {
    throw new Error("Formulaire introuvable")
  }
  
  // Créer une copie
  const duplicate = await prisma.donationForm.create({
    data: {
      ...original,
      id: undefined, // Générer un nouvel ID
      title: `${original.title} (Copie)`,
      slug: `${original.slug}-copie-${Date.now()}`,
      status: "DRAFT",
      totalCollected: 0,
      donationCount: 0,
      viewCount: 0,
      submissionCount: 0,
      conversionRate: 0,
      publishedAt: null,
      createdAt: undefined,
      updatedAt: undefined,
    },
  })
  
  // Revalider la page
  revalidatePath("/dashboard/formulaires")
  
  return { success: true, duplicate }
}
```

### 4.5 Action de Suppression de Formulaire

**Créer:** `/apps/web/app/actions/forms/delete-form.ts`

```typescript
"use server"

import { prisma } from "@/lib/prisma"
import { requireAuth, requireRole } from "@/lib/auth/get-session"
import { revalidatePath } from "next/cache"

export async function deleteFormAction(formId: string) {
  const session = await requireAuth()
  await requireRole(["ADMIN", "DIRECTOR"]) // Seuls ADMIN et DIRECTOR peuvent supprimer
  
  // Vérifier que le formulaire existe et appartient à l'organisation
  const form = await prisma.donationForm.findUnique({
    where: {
      id: formId,
      organizationId: session.user.organizationId,
    },
    include: {
      _count: {
        select: { submissions: true },
      },
    },
  })
  
  if (!form) {
    throw new Error("Formulaire introuvable")
  }
  
  // Empêcher la suppression si le formulaire a des soumissions
  if (form._count.submissions > 0) {
    throw new Error(
      "Impossible de supprimer un formulaire qui a reçu des dons. Archivez-le plutôt."
    )
  }
  
  // Supprimer le formulaire
  await prisma.donationForm.delete({
    where: { id: formId },
  })
  
  // Revalider la page
  revalidatePath("/dashboard/formulaires")
  
  return { success: true }
}
```

### 4.6 Action de Changement de Statut

**Créer:** `/apps/web/app/actions/forms/update-form-status.ts`

```typescript
"use server"

import { prisma } from "@/lib/prisma"
import { requireAuth } from "@/lib/auth/get-session"
import { revalidatePath } from "next/cache"

export async function updateFormStatusAction(
  formId: string,
  status: "DRAFT" | "PUBLISHED" | "ARCHIVED"
) {
  const session = await requireAuth()
  
  // Mettre à jour le statut
  const form = await prisma.donationForm.update({
    where: {
      id: formId,
      organizationId: session.user.organizationId,
    },
    data: {
      status,
      publishedAt: status === "PUBLISHED" ? new Date() : undefined,
    },
  })
  
  // Revalider les pages
  revalidatePath("/dashboard/formulaires")
  revalidatePath(`/dashboard/formulaires/${formId}`)
  
  return { success: true, form }
}
```

---

## 5. Dépendances NPM

```bash
# Graphiques
npm install recharts

# Copie dans le presse-papiers
npm install react-copy-to-clipboard
npm install -D @types/react-copy-to-clipboard
```

---

## 6. Vérifications Importantes

Avant de finaliser, assurez-vous que :

- ✅ La page liste des formulaires est créée
- ✅ Les 4 KPI cards affichent les statistiques globales
- ✅ La recherche fonctionne en temps réel
- ✅ Les filtres par statut fonctionnent
- ✅ Le tri par colonne fonctionne
- ✅ La pagination fonctionne
- ✅ La page de statistiques d'un formulaire est créée
- ✅ Les graphiques s'affichent correctement
- ✅ L'action de duplication fonctionne
- ✅ L'action de suppression vérifie les permissions et les soumissions
- ✅ Le changement de statut fonctionne
- ✅ Le design respecte le design system
- ✅ Les pages sont responsive

---

## 7. Prochaine Étape

Une fois cette étape complétée, Manus préparera les instructions pour **2.1.3 - Form Builder (Créateur de Formulaire)**.

---

## Référence Cahier des Charges

- Section 5.2.1 - Création de Formulaires Personnalisables
- Section 15.1 - Performance (chargement < 3 sec)
